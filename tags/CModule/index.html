<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: CModule - Meng Xipeng&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Meng Xipeng&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Meng Xipeng&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Meng Xipeng&#039;s blog"><meta property="og:url" content="http://mengxipeng1122.github.io/"><meta property="og:site_name" content="Meng Xipeng&#039;s blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://mengxipeng1122.github.io/img/og_image.png"><meta property="article:author" content="Meng Xipeng"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://mengxipeng1122.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://mengxipeng1122.github.io"},"headline":"Meng Xipeng's blog","image":["http://mengxipeng1122.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Meng Xipeng"},"publisher":{"@type":"Organization","name":"Meng Xipeng's blog","logo":{"@type":"ImageObject","url":"http://mengxipeng1122.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">CModule</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-28T01:34:03.000Z" title="6/28/2022, 9:34:03 AM">2022-06-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">6 minutes read (About 966 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/28/A-new-method-to-write-CModule-in-Frida-for-hacking-Android-applications/">A new method to write CModule in Frida for hacking Android applications</a></p><div class="content"><h1 id="Why-a-new-method"><a href="#Why-a-new-method" class="headerlink" title="Why a new method"></a>Why a new method</h1><p>I introduced how to use official CModule in Frida at <a href="/2022/06/27/How-to-use-CMoudule-in-Frida/">last post</a>. But I think it have some weaknesses to improve. </p>
<ul>
<li>It can use C, this make us need to use ugly mangled function name when we want to call C++ functions</li>
<li>We need to embed C code in to Typescript code. So we can not find the error line quickly when C code does not pass compilation.</li>
</ul>
<h1 id="New-method"><a href="#New-method" class="headerlink" title="New method"></a>New method</h1><p>In here, I will introduce a new method to write a CModule in Frida. Please note, this method only work with Android platform, and I only tested on Arm32 archtecture. In theory, Arm64 archtecture should work either. This method has the following stage:</p>
<ul>
<li>Write a .so using Android NDK</li>
<li>Convert .so to a typescript module to hold all informations we needs when we want to load the .so</li>
<li>Load .so in Frida and call one function in it.<br>I tried to load .so using Module.load(), but this method always failed on Android platform. I think it because the restrictions of new versions Android, I used Android 10.</li>
</ul>
<h2 id="Write-a-so-using-Android-NDK"><a href="#Write-a-so-using-Android-NDK" class="headerlink" title="Write a .so using Android NDK"></a>Write a .so using Android NDK</h2><p>First, we write a .so in C++, the following is the code in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/main.cpp">main.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// declaration of functions in frida</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">frida_log_callback</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">frida_hexdump_callback</span><span class="params">(<span class="type">void</span>*, <span class="type">unsigned</span> <span class="type">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// declaration of functions in libMyGame.so</span></span><br><span class="line"><span class="keyword">namespace</span> cocos2d&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">        <span class="function"><span class="type">static</span> Application* <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function">std::string&amp;  <span class="title">getVersion</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">frida_log_callback</span>(<span class="string">&quot;Hello World from so&quot;</span>);</span><br><span class="line">    <span class="built_in">frida_log_callback</span>(<span class="string">&quot;cocos2d application version:&quot;</span>);</span><br><span class="line">    <span class="type">const</span> std::string&amp; version  = cocos2d::Application::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getVersion</span>();</span><br><span class="line">    <span class="built_in">frida_log_callback</span>(version.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Line 3-4, declares functions in Frida. And we need to add a options in our <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/Android.mk">Android.mk</a></p>
<blockquote>
<p>LOCAL_ALLOW_UNDEFINED_SYMBOLS :&#x3D; true</p>
</blockquote>
<p>Without this options, we can not pass the link because the compiler can not find these functions.<br>Line 8-13, declares functions in libMyGame.so. We can use C++ syntax here, and make our code more readable. And we need to declare entire C++ class in libMyGame.so, just declare the functions we want to call.<br>Line 16-23, defines a function for Typescript code to call. It just does the same thing as we did in <a href="/2022/06/27/How-to-use-CMoudule-in-Frida/">previous post</a>, print out cocos2d application version string.<br>And we need to set correct options in <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/Application.mk">Application.mk</a>. </p>
<blockquote>
<p>APP_STL :&#x3D; gnustl_static<br>APP_ABI&#x3D;armeabi-v7a</p>
</blockquote>
<p>If these options is not compatible with libMyGame.so, our function will crush. Frankly, I tried all <code>APP_STL</code> variables, and finally find only <code>gnustl_static</code> is compatible with this game.</p>
<h2 id="Generate-a-Typescript-file-hold-all-information-when-loading"><a href="#Generate-a-Typescript-file-hold-all-information-when-loading" class="headerlink" title="Generate a Typescript file hold all information when loading"></a>Generate a Typescript file hold all information when loading</h2><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/pyscripts/so2tsmodule.py">python script</a>. This python scripts use <a target="_blank" rel="noopener" href="https://lief-project.github.io/">lief</a> to parse .so file to get the following informations.</p>
<ul>
<li>name, machine type </li>
<li>segments<br>  Only care about segments with load type, discard other segments</li>
<li>export symbols</li>
<li>relocations</li>
<li>ctors<br>  This is a list of functions, and we need to call these functions after loading.</li>
<li>dtors<br>  These functions should be called when unload the .so file, and I have not write code for it now.</li>
</ul>
<p>This script generates final Typescript file using <a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.9.x/intro/">jinja2</a>. The name of the template file is <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/pyscripts/so2tsmodule.jinja">so2tsmodule.jinja</a></p>
<h2 id="Load-so-file"><a href="#Load-so-file" class="headerlink" title="Load .so file"></a>Load .so file</h2><p>I wrote a method, named <code>loadSo</code>, in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/soutils.ts">soutils.ts</a>. Method prototype as follows</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">loadSo</span>(<span class="params">info:SoInfoType, syms?:&#123;[key:<span class="built_in">string</span>]:NativePointer&#125;, libs?:<span class="built_in">string</span>[]</span>):<span class="title class_">LoadSoInfoType</span></span><br></pre></td></tr></table></figure>
<ul>
<li>info is a object we defined in the Typescript file we generated in the last stage. </li>
<li>syms is a list of symbols we pass to the load modules</li>
<li>libs is a list of library names. This method try to find symbols in these libraries.</li>
</ul>
<p>We need to accomplish the following stages when load .so file:</p>
<ul>
<li>Allocate buffer, and set the permission to <code>rwx</code></li>
<li>Write all segments need to load to the buffer </li>
<li>Create a variable to hold all export symbols in the .so file</li>
<li>Handle relocations<br>  This stage is a little complicated. We need to find symbol addresses, and write correct number in the correct address accord to different recolcaion type.</li>
<li>Call ctors</li>
</ul>
<h2 id="Run-the-function-in-the-so-file"><a href="#Run-the-function-in-the-so-file" class="headerlink" title="Run the function in the .so file"></a>Run the function in the .so file</h2><p>The following is the Typescript code to do this. And it’s in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/sotest.ts">sotest.ts</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> soname =<span class="string">&quot;libMyGame.so&quot;</span></span><br><span class="line"><span class="keyword">let</span> m = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(soname)</span><br><span class="line"><span class="keyword">let</span> loadm = soutils.<span class="title function_">loadSo</span>(</span><br><span class="line">    mysoinfo.<span class="property">info</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        frida_log_callback : fridautils.<span class="property">frida_log_callback</span>,</span><br><span class="line">        frida_hexdump_callback : fridautils.<span class="property">frida_hexdump_callback</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    [</span><br><span class="line">        soname,</span><br><span class="line">    ]</span><br><span class="line">);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(loadm))</span><br><span class="line"></span><br><span class="line">fridautils.<span class="title function_">runFunWithExceptHandling</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(loadm.<span class="property">syms</span>.<span class="property">fun</span>,<span class="string">&#x27;void&#x27;</span>,[])</span><br><span class="line">    <span class="title function_">fun</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Line 3-12, loads the .so file.<br>We need to import generated Typescript file as a module using the following code </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> mysoinfo <span class="keyword">from</span> <span class="string">&#x27;./mysoinfo&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Line 6-7 lists all functions defined in Frida and will be called in C++ code<br>Line 10 lists all libraries contained the functions will be called in C++ code<br>Line 16-17 calls function <code>fun</code> in the C++ code.</p>
<h1 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h1><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following command to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_sotest</span><br></pre></td></tr></table></figure>
<p>And use the following command to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows</p>
<blockquote>
<p>Hello World from so<br>cocos2d application version:<br>1.8.12</p>
</blockquote>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a>.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-27T01:34:16.000Z" title="6/27/2022, 9:34:16 AM">2022-06-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">8 minutes read (About 1251 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/27/How-to-use-CMoudule-in-Frida/">How to use CModule in Frida</a></p><div class="content"><p>In this article, I will try to introduce how to use CModule in Frida.<br>My test Android APK is a small game, named “Knife hit”, you can download it from <a target="_blank" rel="noopener" href="https://apkpure.com/knife-hit/com.ketchapp.knifehit">APKpure website</a>. This is a Cocos2d game, it has a native library named ‘libMyGame.so’. This library file has many game logic codes. It exports many functions. We will try to call one of them to get Cocos2d application version and print out it. </p>
<h1 id="Why-typescript"><a href="#Why-typescript" class="headerlink" title="Why typescript?"></a>Why typescript?</h1><p>Later version of Frida support typescript. And Frida provides a <a target="_blank" rel="noopener" href="https://github.com/oleavr/frida-agent-example.git">demo</a> for starting of typescript coding. It use a NPM package, ‘<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/frida-compile">frida-compile</a>‘, for compiling of typescript code. Using typescript needs a compilation, it might take longer time to test the code, but we can avoid many issues in compilation. So I prefer typescript. </p>
<h1 id="What-is-a-CMoudule"><a href="#What-is-a-CMoudule" class="headerlink" title="What is a CMoudule"></a>What is a CMoudule</h1><p>This is its <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#cmodule">official documentation</a>. In my option, we can write some functions in C, and Frida provides a way to invoke these functions. The following is the example in the official documentation.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void hello(void) &#123;</span></span><br><span class="line"><span class="string">  printf(&quot;Hello World from CModule\\n&quot;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(cm));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(cm.<span class="property">hello</span>, <span class="string">&#x27;void&#x27;</span>, []);</span><br><span class="line"><span class="title function_">hello</span>();</span><br></pre></td></tr></table></figure>
<p>Line 1-7 create a CModule, it includes C code, and exports one function, ‘hello’ to print a welcome string.<br>Line 9 displays the information of the CModule. Frida is very smart, the C code should be compiled in here. And Frida should load the CModule in the memory space of the target process.<br>Line 11 convert function pointer to a NativeFunction for calling in Frida. So, cm.hello just is a NativePoiner.<br>Line 12 call hello function</p>
<h1 id="Write-our-own-CModule"><a href="#Write-our-own-CModule" class="headerlink" title="Write our own CModule"></a>Write our own CModule</h1><h2 id="Why-not-to-use-printf"><a href="#Why-not-to-use-printf" class="headerlink" title="Why not to use printf?"></a>Why not to use printf?</h2><p>Typescript code and C code is actually run in the target process’ memory space. And Android process usually do not use printf. They use <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/reference/group/logging#__android_log_print">__android_log_print</a> instead. But this function do not print message to Frida, we nee to run <code>adb logcat</code> to check its output. It’s not very convenience. We can write some functions in typescript to let C code to call.</p>
<h2 id="Typescript-functions-for-debugging"><a href="#Typescript-functions-for-debugging" class="headerlink" title="Typescript functions for debugging"></a>Typescript functions for debugging</h2><p>I wrote several helper functions in typescript, I put them in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/fridautilts.ts">fridautils.ts</a>.</p>
<h3 id="frida-log-callback"><a href="#frida-log-callback" class="headerlink" title="frida_log_callback"></a>frida_log_callback</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> frida_log_callback = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">sp:NativePointer</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> s = sp.<span class="title function_">readUtf8String</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>This function has one argument of type NativePointer. C code passes a pointer to a string to this function.<br>Line 2 read a string from given address.<br>Line 3 outputs the string to Frida.</p>
<h3 id="frida-log-cstring-callback"><a href="#frida-log-cstring-callback" class="headerlink" title="frida_log_cstring_callback"></a>frida_log_cstring_callback</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> frida_log_cstring_callback = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">pString:NativePointer</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> s = pString.<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readPointer</span>().<span class="title function_">readUtf8String</span>(); <span class="comment">// get string to a pointer to a std::string object</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>Cocos2D stores the version string in a std::string. So we needs a function to extract the actual string from the std::string object and print it.<br>This function has only one argument, it also is of type NativePoiner, but it should be a pointer to a std::string object<br>Line 2 extracts the actual string from the given std::string object. Note: Android developers can specify different variable in their <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/application_mk">Application.mk</a> file. Variables APP_ABI, APP_STL may determine different implementations of std::string class. So current method to extract a string may not work correctly when you hack other Android APKs.<br>Line 3 outputs extracted string to Frida.</p>
<h2 id="Our-own-CModule"><a href="#Our-own-CModule" class="headerlink" title="Our own CModule"></a>Our own CModule</h2><p>I wrote a CModule to show the Cocos2D application version string by using the functions has exist in libMyGame.so. I put code it file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/cmoduletest.ts">cmoduletest.ts</a>.</p>
<h3 id="Cocos2d-functions-for-get-version-string"><a href="#Cocos2d-functions-for-get-version-string" class="headerlink" title="Cocos2d functions for get version string"></a>Cocos2d functions for get version string</h3><p>I read the <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.0rc2/db/de2/classcocos2d_1_1_application.html">official documentation</a> in Cocos2d website. Class cocos2d::Application has 2 function we can use:</p>
<ul>
<li>static Application* getInstance 	()<br>  <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.0rc2/db/de2/classcocos2d_1_1_application.html#aa98b8f5621b53c808429f5dde0662921">doc</a><br>  This function return a pointer to the current application instance.</li>
<li>const std::string&amp; getVersion () const<br>  <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.3rc0/dc/db1/classcocos2d_1_1extension_1_1_manifest.html#aad022179566240a5612dfa964152d704">doc</a><br>  This function return a std::string reference to the version string. A C++ reference is a pointer in machine code actually.</li>
</ul>
<h3 id="Call-Cocos2d-functions"><a href="#Call-Cocos2d-functions" class="headerlink" title="Call Cocos2d functions"></a>Call Cocos2d functions</h3><p>The following is the code </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test0 = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> soname =<span class="string">&quot;libMyGame.so&quot;</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(soname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> loadm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        void* _ZN7cocos2d11Application11getInstanceEv ();</span></span><br><span class="line"><span class="string">        const char* _ZN7cocos2d11Application10getVersionEv(void*);</span></span><br><span class="line"><span class="string">        extern void frida_log_callback(const char* s);</span></span><br><span class="line"><span class="string">        extern void frida_log_cstring_callback(void*);</span></span><br><span class="line"><span class="string">        void fun(void) &#123;</span></span><br><span class="line"><span class="string">            frida_log_callback(&quot;Hello World from CModule&quot;);</span></span><br><span class="line"><span class="string">            void* pApplication = _ZN7cocos2d11Application11getInstanceEv();</span></span><br><span class="line"><span class="string">            const char* version = _ZN7cocos2d11Application10getVersionEv(pApplication);</span></span><br><span class="line"><span class="string">            frida_log_callback(&quot;cocos2d application version: &quot;);</span></span><br><span class="line"><span class="string">            frida_log_cstring_callback((void*)version);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      frida_log_callback  : fridautils.<span class="property">frida_log_callback</span>,</span><br><span class="line">      frida_log_cstring_callback  : fridautils.<span class="property">frida_log_cstring_callback</span>,</span><br><span class="line">      <span class="comment">// cocos2d::Application::getInstance</span></span><br><span class="line">      <span class="comment">// use this static function  to get a pointer to the current Application instance</span></span><br><span class="line">      _ZN7cocos2d11Application11getInstanceEv : m.<span class="title function_">getExportByName</span>(<span class="string">&quot;_ZN7cocos2d11Application11getInstanceEv&quot;</span>), </span><br><span class="line">      <span class="comment">// const char* cocos2d::Application::getVersion(void*)</span></span><br><span class="line">      <span class="comment">// use this member function of class Application to get a version string </span></span><br><span class="line">      <span class="attr">_ZN7cocos2d11Application10getVersionEv</span>: m.<span class="title function_">getExportByName</span>(<span class="string">&quot;_ZN7cocos2d11Application10getVersionEv&quot;</span>), </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(loadm));</span><br><span class="line">    fridautils.<span class="title function_">runFunWithExceptHandling</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(loadm.<span class="property">fun</span>, <span class="string">&#x27;void&#x27;</span>,[])</span><br><span class="line">        <span class="title function_">fun</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Line 6-16 is the C code.<br>Line 6-7 declares the Cocos2d functions we will using. Because we are in C, so we only can use mangled function names.<br>Line 8-9 declares the helper functions we created in Typescript.<br>Line 10-16, we create a function named <code>fun</code> to do our actual work<br>Line 12, we get the current application instance address using function cocos2d::Application::getInstance, this function is a static function, and it has no argument, we store the result to variable <code>pApplication</code>;<br>Line 13, we get a pointer to a std::string object  using function cocos2d::Application::getVersion, this function is a member function, and it needs a <code>this</code> pointer as its first argument. We just pass variable <code>pApplication</code> to it.<br>Line 14-15. We print version string using helper functions.<br>LIne 19-26. We needs to pass all functions to the CModule using a dictionary. In the dictionary,  key is the function name, and value is the function address.  We call Module.getExportByName to get the functions address in the libMyGame.so</p>
<h2 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h2><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following cmd to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_cmoduletest</span><br></pre></td></tr></table></figure>
<p>And use the following cmd to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows</p>
<blockquote>
<p>Hello World from CModule<br>cocos2d application version:<br>1.8.12<br>This game’s Cocos2d application version is <code>1.8.12</code></p>
</blockquote>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Now, we know how to call the existing functions using CModule. Cocos2D exports a lot of functions in its native library file. We can do many things using these functions.<br>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a></p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Meng Xipeng"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Meng Xipeng</p><p class="is-size-6 is-block">Reverse engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/mengxipeng1122" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/meng_xi_peng"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-07T08:42:04.000Z">2024-01-07</time></p><p class="title"><a href="/2024/01/07/How-to-indentify-NDK-version-of-a-so/">Identifying the NDK Version of a .so File</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-28T00:41:13.000Z">2023-10-28</time></p><p class="title"><a href="/2023/10/28/Hacking-Cocos2D-Android-Games-using-Frida/">Hacking Cocos2D Android Games using Frida</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-31T07:24:00.000Z">2023-08-31</time></p><p class="title"><a href="/2023/08/31/Hacking-Android-game-using-Frida-Part3/">Hacking Android Game using Frida - Part3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-29T06:53:23.000Z">2023-08-29</time></p><p class="title"><a href="/2023/08/29/Hacking-Android-game-using-Frida-Part2/">Hacking Android game using Frida - Part2</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-29T03:26:43.000Z">2023-08-29</time></p><p class="title"><a href="/2023/08/29/Hacking-Android-game-using-Frida-Part1/">Hacking Android game using Frida - Part1</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ARM/"><span class="tag">ARM</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CModule/"><span class="tag">CModule</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos2d/"><span class="tag">Cocos2d</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Frida/"><span class="tag">Frida</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Game/"><span class="tag">Game</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hack/"><span class="tag">Hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hacking/"><span class="tag">Hacking</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Inline-hook/"><span class="tag">Inline hook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse/"><span class="tag">Reverse</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-engineering/"><span class="tag">Reverse engineering</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thumb/"><span class="tag">Thumb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hack/"><span class="tag">hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hacking/"><span class="tag">hacking</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inlinehook/"><span class="tag">inlinehook</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Meng Xipeng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>