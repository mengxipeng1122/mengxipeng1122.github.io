<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: Reverse - Meng Xipeng&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Meng Xipeng&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Meng Xipeng&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Meng Xipeng&#039;s blog"><meta property="og:url" content="http://mengxipeng1122.github.io/"><meta property="og:site_name" content="Meng Xipeng&#039;s blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://mengxipeng1122.github.io/img/og_image.png"><meta property="article:author" content="Meng Xipeng"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://mengxipeng1122.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://mengxipeng1122.github.io"},"headline":"Meng Xipeng's blog","image":["http://mengxipeng1122.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Meng Xipeng"},"publisher":{"@type":"Organization","name":"Meng Xipeng's blog","logo":{"@type":"ImageObject","url":"http://mengxipeng1122.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">Reverse</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-01-22T07:22:24.000Z" title="1/22/2024, 3:22:24 PM">2024-01-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-22T14:49:42.201Z" title="1/22/2024, 10:49:42 PM">2024-01-22</time></span><span class="level-item">7 minutes read (About 1040 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/01/22/Mastering-Frida-A-Guide-to-Fixing-Early-Instrumentation-in-Gadget-Mode/">Mastering Frida: A Guide to Fixing Early Instrumentation in Gadget Mode</a></p><div class="content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>One of the challenges faced in Frida’s Gadget mode is an issue where the process you’re injecting into resumes immediately after injecting the JavaScript. This behavior prevents early instrumentation, which can be crucial for certain analysis tasks. In this blog post, I will guide you through a workaround to fix this issue.</p>
<p>When it comes to dynamic analysis and instrumentation of applications, Frida stands out as an indispensable tool in the kit of developers, reverse engineers, and security researchers alike. Its Gadget mode, in particular, offers unparalleled flexibility, allowing users to inject custom scripts into their target applications seamlessly. However, there’s a snag in the system that’s been tripping up professionals—early instrumentation.</p>
<p>Imagine setting up a meticulous script, ready to unravel the inner workings from the very inception of a process only to find that Frida has already allowed the application to resume before your instrumentation could catch the critical initial functions. This challenge has been particularly pronounced with the latest release, version 16.1.11, posing a significant obstacle to those needing to hook functions at the outset of program execution.</p>
<p>This blog post is forged from the need for a solution—crafted for persistence, it’s a beacon of hope for those grappling with this issue. Herein, we’ll walk through the intricacies of Frida’s Gadget mode and unveil a strategic approach to modify the <code>resume_on_attach</code> flag, a crucial step in gaining the control you require for early instrumentation. By the end of this guide, you’ll have mastered the method to hold the execution reins, ensuring your scripts are primed to hook at the starting line.</p>
<p>Join me as we delve into this technical deep-dive, transforming a point of frustration into a triumph of technical prowess.</p>
<h2 id="Choosing-Gadget-Mode-over-Server-Mode"><a href="#Choosing-Gadget-Mode-over-Server-Mode" class="headerlink" title="Choosing Gadget Mode over Server Mode"></a>Choosing Gadget Mode over Server Mode</h2><p>In gernal, Frida provides 2 modes for injection, Sever mode and Dadget mode. I am debug an ARM32 program on an embedded patlform. And I tested, the server mode is not very reliable , may because the limit RAM on the dev board, and the dev board may reboot after I start frida-server, It’s very annonying, So I select Gadget mode,and reboot issue goes away. Frida offers two distinct modes for script injection: Server Mode and Gadget Mode. When working with ARM32 programs on embedded platforms, one must consider system constraints. My experience revealed that Server Mode could be unstable, potentially due to the limited RAM available on the development board. This instability often resulted in the board rebooting after initiating frida-server, which was disruptive to the debugging process.</p>
<p>Given these challenges, I opted for Gadget Mode. This alternative proved to be more stable under the same conditions, eliminating the frustrating reboot issues. Gadget Mode’s lightweight footprint makes it better suited for environments with resource limitations, thereby providing a more seamless and reliable debugging experience for ARM32 embedded systems.</p>
<h2 id="The-Solution-Modifying-resume-on-attach"><a href="#The-Solution-Modifying-resume-on-attach" class="headerlink" title="The Solution: Modifying resume_on_attach"></a>The Solution: Modifying <code>resume_on_attach</code></h2><p>The root of this issue lies within the default behavior of Frida’s Gadget mode, which is controlled by the <code>resume_on_attach</code> field of the <code>ControlChannel</code> class. This field dictates whether the process should resume immediately after Frida attaches to it.</p>
<h3 id="Step-by-Step-Fix"><a href="#Step-by-Step-Fix" class="headerlink" title="Step by Step Fix"></a>Step by Step Fix</h3><p>Here’s a step-by-step guide to addressing this issue:</p>
<h3 id="1-Modifying-the-ControlChannel-Class"><a href="#1-Modifying-the-ControlChannel-Class" class="headerlink" title="1. Modifying the ControlChannel Class"></a>1. Modifying the <code>ControlChannel</code> Class</h3><p>Locate the <code>ControlChannel</code> class definition within the <code>frida-core/lib/gadget/gadget.vala</code> file. Search for the <code>resume_on_attach</code> field and change its default value to <code>false</code>.</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ControlChannel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">bool</span> resume_on_attach = <span class="literal">false</span>; <span class="comment">// Change from true to false</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Compile-Frida-with-Modified-Code"><a href="#2-Compile-Frida-with-Modified-Code" class="headerlink" title="2. Compile Frida with Modified Code"></a>2. Compile Frida with Modified Code</h3><p>After making this change, recompile Frida to incorporate the modification. Ensure you have all required dependencies and follow the standard build instructions provided in the Frida documentation. <a target="_blank" rel="noopener" href="https://github.com/frida/docker-images">This github repository</a> provides docker images for compiling Frida.</p>
<h3 id="3-Using-the-Modified-libGadget-so"><a href="#3-Using-the-Modified-libGadget-so" class="headerlink" title="3. Using the Modified libGadget.so"></a>3. Using the Modified libGadget.so</h3><p>Replace the original libGadget.so with the newly compiled version. With this change, the process will no longer resume immediately, allowing your JavaScript to hook functions at the very start of the execution.</p>
<h3 id="4-Utilizing-Python-Script-for-Process-Resumption-in-Frida-Gadget-Mode"><a href="#4-Utilizing-Python-Script-for-Process-Resumption-in-Frida-Gadget-Mode" class="headerlink" title="4. Utilizing Python Script for Process Resumption in Frida Gadget Mode"></a>4. Utilizing Python Script for Process Resumption in Frida Gadget Mode</h3><p>While working in Frida Gadget mode, a common approach to inject a JavaScript payload into the target process would involve using the <code>frida</code> command from the Frida-tools package, like so:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -H &lt;Board IP address&gt; -n Gadget -l &lt;Javascript file&gt;</span><br></pre></td></tr></table></figure>

<p>Executing this command initiates the injection, but it doesn’t automatically resume the process once the JavaScript file is loaded. Attempts to resume the process manually with <code>%resume</code> in the Frida REPL might not yield success.</p>
<p>To overcome this hurdle, I developed a Python script—a more reliable solution. The script not only injects the JavaScript code but also effectively resumes the process afterwards. Below is the functional part of the script where the <code>device.resume(pid);</code> command is used to resume the process:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python script to inject JavaScript and resume process in Frida Gadget mode</span></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="comment"># Establish a connection to the target device</span></span><br><span class="line">device = frida.get_device_manager().add_remote_device(<span class="string">&quot;&lt;Board IP address&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the target process identifier (replace &#x27;pid&#x27; with the actual process ID)</span></span><br><span class="line">pid = <span class="string">&#x27;pid&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to the JavaScript file you want to inject</span></span><br><span class="line">js_file_path = <span class="string">&quot;&lt;Javascript file&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read the JavaScript code from the file</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(js_file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    js_code = file.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Inject the JavaScript code into the process</span></span><br><span class="line">session = device.attach(pid)</span><br><span class="line">script = session.create_script(js_code)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load and execute the JavaScript code</span></span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resume the process to continue its execution with the injected code</span></span><br><span class="line">device.resume(pid)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;JavaScript injected and process resumed.&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>By employing this script, we ensure that the injection and process flow are controlled as expected, thus maintaining the stability of the debugging session.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This blog post addressed early instrumentation challenges in Frida’s Gadget mode and provided a solution by modifying the resume_on_attach flag. Gadget mode was recommended over Server mode for ARM32 programs on embedded platforms due to its stability. A Python script was introduced for injecting JavaScript and resuming the process, ensuring a controlled debugging session. Overall, this post offers a solution for fixing early instrumentation in Frida, empowering developers and researchers to gain insights into application behavior from the beginning.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-25T01:14:27.000Z" title="7/25/2022, 9:14:27 AM">2022-07-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">4 minutes read (About 625 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/25/An-inlinehook-library-using-Frida/">An inlinehook library using Frida</a></p><div class="content"><p>This article introduces an inline hook library using Frida, and you can download all codes about this at this <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/frida-android-inlinehook.git">link</a>. And I only implement it on ARM64 architecture.</p>
<h1 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h1><p>In my opinion, <code>inlinehook</code> just like put a breakpoint in debugger. Users can hook at any instructions, and executes any codes once the hook is triggered.</p>
<h1 id="How-to-implement-it"><a href="#How-to-implement-it" class="headerlink" title="How to implement it"></a>How to implement it</h1><h2 id="Basic-steps"><a href="#Basic-steps" class="headerlink" title="Basic steps"></a>Basic steps</h2><ul>
<li>Put a jump code at the hook point, to jump to our trampoline code. </li>
<li>Trampoline code does the following:<ul>
<li>Save current registers.</li>
<li>Invoke hook handler function.</li>
<li>Restore all registers.</li>
<li>Execute instructions at hook point.</li>
<li>Jump back to next instruction after the hook point.</li>
</ul>
</li>
</ul>
<h2 id="Implementation-using-Frda"><a href="#Implementation-using-Frda" class="headerlink" title="Implementation using Frda"></a>Implementation using Frda</h2><h3 id="How-to-add-hook"><a href="#How-to-add-hook" class="headerlink" title="How to add hook"></a>How to add hook</h3><p>Before add inline hook, user should prepare the following things:</p>
<ul>
<li>Hook point<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hook_ptr = <span class="language-xml"><span class="tag">&lt;<span class="name">Address</span> <span class="attr">of</span> <span class="attr">the</span> <span class="attr">instruction</span> <span class="attr">will</span> <span class="attr">be</span> <span class="attr">hooked</span>&gt;</span> ;</span></span><br></pre></td></tr></table></figure>
We can add hooks at any instruction.</li>
<li>Hook handle function<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> frida_fun = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">para1:NativePointer, sp:NativePointer</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;para1&#x27;</span>, para1, <span class="string">&#x27;sp&#x27;</span>, sp);</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
This function has two arguments, all are of type NativePointer. The first argument is named <code>para1</code>, and we can assign it when we add hook, the second argument is named <code>sp</code>, of value in the <code>sp</code> register, we can access values in the stack by this argument.</li>
<li>Memory for trampoline code<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> trampoline_ptr = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(trampoline_len)</span><br></pre></td></tr></table></figure>
We can allocate a new memory for trampoline code. And because allocated memory is usually far from the hook point, so we have to use a long jump instruction at the hook point. Long jump instruction usually occupies more bytes. For using near jump instruction, we can try to find a cave near the hook point, and use the found cave to store trampoline code.<blockquote>
<p>Warning: when we allocate memory, do not use a local variable for the returned pointer, use a global variable instead. Javascript’s garbage collection mechanism will free this memory automatically once the program is out of the local variable’s scope, and will crash the process. </p>
</blockquote>
</li>
<li>Parameter1 pass to hook handle function <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> para1 = <span class="language-xml"><span class="tag">&lt;<span class="name">parameter1</span> <span class="attr">pass</span> <span class="attr">to</span> <span class="attr">hook</span> <span class="attr">handle</span> <span class="attr">function</span>&gt;</span>;</span></span><br></pre></td></tr></table></figure>
We can pass a parameter to the hook handle function, and this parameter is of type NativePointer</li>
</ul>
<p>Now invoke <code>InlineHooker.inlineHookPatch</code> to add a inline hook, just as follows</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sz = <span class="title class_">InlineHooker</span>.<span class="title function_">inlineHookPatch</span>(trampoline_ptr,hook_ptr, hook_fun_ptr, para1);</span><br></pre></td></tr></table></figure>
<p>This function return a number, indicating the length of the trampoline code. </p>
<h3 id="Code-relocation"><a href="#Code-relocation" class="headerlink" title="Code relocation"></a>Code relocation</h3><p>For inline hook, we need to move some instructions from one address to another. And we need to rewrite some instructions, just like B&#x2F;BL instruction in ARM64 architecture.<br>I am using the code in this <a target="_blank" rel="noopener" href="https://github.com/bytedance/android-inline-hook.git">link</a> for rewriting instructions. I port the C code in this <a target="_blank" rel="noopener" href="https://github.com/bytedance/android-inline-hook/blob/main/shadowhook/src/main/cpp/arch/arm64/sh_a64.c">file</a> to Typescript code. <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/frida-android-inlinehook/blob/master/src/sh_a64.ts">This file</a> is my ported code. ARM64 instruction set is relatively easy, and Thumb&#x2F;Arm32 is too complex, we may port its code in the future.<br>This file exports this method to rewrite code</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span>  sh_a64_rewrite=(<span class="attr">buf</span>:<span class="title class_">NativePointer</span>, <span class="attr">inst</span>:<span class="built_in">number</span>, <span class="attr">pc</span>:<span class="title class_">NativePointer</span> ):<span class="function"><span class="params">number</span>=&gt;</span></span><br></pre></td></tr></table></figure>
<p>This method has 3 arguments</p>
<ul>
<li>buf, the target address of current instruction </li>
<li>inst, current instruction</li>
<li>pc, the source address of current instruction<br>This method also return a variable of type number, to indicate how many instructions has written to target address.  We actually need to rewrite several instructions for one B instruction to avoid change its behavior.</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I wrote an inline hook library using Frida. Inline Hooking is not very easy, specially in some architecture, I only implemented on ARM64, and will do more work on other architecture.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-29T01:41:19.000Z" title="6/29/2022, 9:41:19 AM">2022-06-29</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">10 minutes read (About 1437 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/29/Inline-hook-with-Frida-Thumb-version/">Inline hook with Frida (Thumb version)</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#interceptor">Interceptor.attach</a> in Frida only can hook one function. So the first argument, <code>target</code>, should be a function address. In my opinion, <code>inline hook</code> just let users can hook arbitrary instruction at any address. In this article, I will try to introduce a method to implement inline hook using Frida. and only implement for Thumb binary so far.</p>
<h1 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h1><p>To implement inline hook, we need to do the following thing:</p>
<ul>
<li>Save original bytes at hook target</li>
<li>Write a hook handle function in .so file in C&#x2F;C++.</li>
<li>Write a trampoline code in Thumb. And put original bytes into trampoline code.</li>
<li>Put a BL instruction at hook target.</li>
</ul>
<p>I will describe every stage in detail, and for convenience, I will user the following terminology:</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>hook_ptr</code></td>
<td>The address of hook target, same as the <code>target</code> argument in <code>Interceptor.attach</code></td>
</tr>
<tr>
<td><code>hook_fun_ptr</code></td>
<td>The address of hook handle function, we define this function in .so file</td>
</tr>
<tr>
<td><code>tempoline_ptr</code></td>
<td>The address of trampoline code</td>
</tr>
</tbody></table>
<p>So if we set every code correctly, once CPU reaches <code>hook_ptr</code>, CPU will call trampoline code as a function. And the trampoline code will call hook handle function and execute the original instruction copy from <code>hook_ptr</code>. And we can do anything we want in hook handle function.</p>
<h2 id="Save-original-bytes-at-hook-ptr"><a href="#Save-original-bytes-at-hook-ptr" class="headerlink" title="Save original bytes at hook_ptr"></a>Save original bytes at <code>hook_ptr</code></h2><p>We will put a BL instruction at this address, so we need to save original bytes at first. In Thumb,  a BL instruction occupies 4 bytes. So we need to save at least 4 bytes. It may include 1-2 Thumb instructions at <code>hook_ptr</code>, and we must be careful in selection of a <code>hook_ptr</code>.</p>
<ul>
<li>Avoid odd <code>hook_ptr</code></li>
<li>Do not select a <code>hook_ptr</code> at a middle of a Thumb instruction</li>
<li>Do not select a <code>hook_ptr</code> at a 2 bytes Thumb instruction followed by a 4 bytes Thumb instruction</li>
</ul>
<p>I dissembled libMyGame.so with the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-objdump -S /tmp/libMyGame.so | <span class="built_in">tee</span> /tmp/libMyGame.s</span><br></pre></td></tr></table></figure>
<p>And, there are 2 files named <code>libMyGame.so</code> in this game. We should use <code>libMyGame.so</code> file in the path <code>lib/armeabi-v7a</code>. Because this file is according to Thumb version. I selected <code>hook_ptr</code> at <code>0x267782</code>: </p>
<blockquote>
<p> 26777e:	9a03      	ldr	r2, [sp, #12]<br> 267780:	6823      	ldr	r3, [r4, #0]<br> 267782:	4630      	mov	r0, r6   @ here, our <code>hook_ptr</code><br> 267784:	429a      	cmp	r2, r3<br> 267786:	d001      	beq.n	26778c &lt;_ZN7cocos2d11Application10getVersionEv@@Base+0x3c&gt;</p>
</blockquote>
<p>This <code>hook_ptr</code> is in the function <code>cocos2d::Application::getVersion</code>. So when call this <code>getVersion</code> function, just like we did in <a href="2022/06/28/A-new-method-to-write-CModule-in-Frida-for-hacking-Android-applications/">previous post</a>, CPU should hit this <code>hook_ptr</code>.  Now, we saved  original bytes <code>30 46 9a 42</code>.<br>Note: <code>arm-linux-gnueabihf-objdump</code> displays instruction bytes from high address to low address. We also can use <code>hexdump</code> to show instruction byte, it’s in a clearer way. The command is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -n 4 -s $((<span class="number">0</span>x267782)) /tmp/libMyGame.so</span><br></pre></td></tr></table></figure>
<p>The output should be as follows:</p>
<blockquote>
<p>00267782  30 46 9a 42                                       |0F.B|<br>00267786</p>
</blockquote>
<h2 id="Write-a-hook-handle-function"><a href="#Write-a-hook-handle-function" class="headerlink" title="Write a hook handle function."></a>Write a hook handle function.</h2><p>The prototype of the hook handle function is as follows, and it’s in the file, <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/main.cpp">main.cpp</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> <span class="title function_">hook_fun</span><span class="params">(<span class="type">void</span>* baseaddress, <span class="type">void</span>* sp)</span>;</span><br></pre></td></tr></table></figure>
<p>This function has 2 arguments. The 1st argument, <code>baseaddress</code>, is the base address of the <code>libMyGame.so</code>, and the 2nd argument, <code>sp</code>, is the value int register SP. Trampoline code will pass these 2 arguments to the hook handle function. <code>baseaddress</code> let us can access any data or function in <code>libMyGame.so</code> very easily. Trampoline code will store most CPU registers in the stack, so we can access these register values using <code>sp</code>.</p>
<h2 id="Write-trampoline-code"><a href="#Write-trampoline-code" class="headerlink" title="Write trampoline code"></a>Write trampoline code</h2><p>This code is in Thumb assembly. I list the code in here, and I put the offset of instructions at the beginning of every line.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">0x0:	push	&#123;r0, r1, r2, r3, r4, r5, r6, r7&#125;</span><br><span class="line">0x2:	push.w	&#123;r8, sb, sl, fp, ip, lr&#125;</span><br><span class="line">0x6:	mrs	r0, apsr</span><br><span class="line">0xa:	push	&#123;r0&#125;</span><br><span class="line">0xc:	nop</span><br><span class="line">0xe:	mov	r1, sp</span><br><span class="line">0x10:	ldr	r0, [pc, #0x14] @ --&gt; 0x28</span><br><span class="line">0x12:	ldr	r4, [pc, #0x18] @ --&gt; 0x2c</span><br><span class="line">0x14:	blx	r4</span><br><span class="line">0x16:	pop	&#123;r0&#125;</span><br><span class="line">0x18:	msr	cpsr_fc, r0</span><br><span class="line">0x1c:	pop.w	&#123;r8, sb, sl, fp, ip, lr&#125;</span><br><span class="line">0x20:	pop	&#123;r0, r1, r2, r3, r4, r5, r6, r7&#125;</span><br><span class="line">0x22:	nop</span><br><span class="line">0x24:	nop</span><br><span class="line">0x26:	bx	lr</span><br><span class="line">0x28:	nop</span><br><span class="line">0x2a:	nop</span><br><span class="line">0x2c:	nop</span><br><span class="line">0x2e:	nop</span><br></pre></td></tr></table></figure>
<p>0x0-0xa, save registers to stack, r0-r12, LR , and CPSR. We can learn more on ARM registers with <a target="_blank" rel="noopener" href="http://www.mathcs.emory.edu/~cheung/Courses/255/Syl-ARM/7-ARM/cpu1.html">this page</a>.<br>0xe, set the 2nd argument,<br>0x10, set the 1nd argument, we load the 1st argument from 0x28, and we will put the base address of <code>libMyGame.so</code> at 0x28 using Frida.<br>0x12, load the address of the hook handle function to R4, and we will put <code>hook_fun_ptr</code> at 0x2c using Frida.<br>0x14, call hook handle function<br>0x16-0x20, load registers from stack.<br>0x22-0x24, run original instructions at here. We will put saved original bytes at here using Frida.<br>0x26, return<br>0x28-0x2a, We store the base address of <code>libMyGame.so</code> at here.<br>0x2c-0x2e, We store the address of hook handle function at here.<br>Whole trampoline code occupies 0x30 bytes.</p>
<h3 id="About-selection-of-trampoline-ptr"><a href="#About-selection-of-trampoline-ptr" class="headerlink" title="About selection of trampoline_ptr"></a>About selection of <code>trampoline_ptr</code></h3><p>We can simple using <code>Memory.alloc</code> for trampoline code. Actually, we use near call instruction. This makes <code>trampoline_ptr</code> can not be too far from <code>hook_ptr</code>. We can find a cave to put our trampoline code in <code>libMyGame.so</code>. <a target="_blank" rel="noopener" href="https://www.hacking.land/2017/06/cave-miner-search-for-code-cave-in-all.html?m=1">CAVE MINER</a> is a great tool for this task. But I just do it manually for this sample case. I use the following command to list all segments in <code>libMyGame.so</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -l  /tmp/libMyGame.so</span><br></pre></td></tr></table></figure>
<p>The following is the output snippet:</p>
<blockquote>
<p>Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align<br>PHDR           0x000034 0x00000034 0x00000034 0x00120 0x00120 R   0x4<br>INTERP         0x000154 0x00000154 0x00000154 0x00013 0x00013 R   0x1<br>    [Requesting program interpreter: &#x2F;system&#x2F;bin&#x2F;linker]<br>LOAD           0x000000 0x00000000 0x00000000 0x691630 0x691630 R E 0x1000<br>LOAD           0x691f38 0x00692f38 0x00692f38 0x36b0c 0x42fac RW  0x1000<br>DYNAMIC        0x6bc6c8 0x006bd6c8 0x006bd6c8 0x00150 0x00150 RW  0x4</p>
</blockquote>
<p>The first load segment is end at 0x691630, and the second load segment is begin at 0x691f38. So cave at 0x691630 is perfect for our tempoline code.</p>
<h2 id="Put-a-BL-instruction-at-hook-target"><a href="#Put-a-BL-instruction-at-hook-target" class="headerlink" title="Put a BL instruction at hook target."></a>Put a BL instruction at hook target.</h2><p>We just use a near instruction to call trampoline code at <code>hook_ptr</code>, using <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#thumbwriter">thumbwriter</a> in Frida for this.</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>I wrote a method in <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/patchutils.ts">patchutils.js</a>, it’s defined as follows:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">putThumbHookPatch</span>(<span class="params">trampoline_ptr:NativePointer, hook_ptr:NativePointer, hook_fun_ptr:NativePointer, para1:NativePointer, origin_inst?:<span class="built_in">number</span>[]</span>):<span class="built_in">number</span></span><br></pre></td></tr></table></figure>
<ul>
<li>The 1st argument, <code>trampoline_ptr</code> is the address of trampoline code</li>
<li>The 2nd argument, <code>hook_ptr</code> is the address of hook target</li>
<li>The 3rd argument, <code>hook_fun_ptr</code> is the address of our hook handle function</li>
<li>The 4th argument, <code>para1</code> is the 1st parameter to our hook handle function, it will be assign to base address of <code>libMyGame.so</code> in caller</li>
<li>The 5th argument, <code>origin_inst</code> is the saved original bytes at <code>hook_ptr</code><br>And it returns the length of the trampoline code<br>I also wrote a test method in inlinehooktest.ts<a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/inlinehooktest.ts"></a>.</li>
</ul>
<h1 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h1><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following command to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_inlinehooktest</span><br></pre></td></tr></table></figure>
<p>And use the following command to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows.</p>
<blockquote>
<p>Hello World from so<br>cocos2d application version:<br>#################### Hook Begin ##############################<br>hook function from so<br>baseaddress 0xc8902000<br> CPSR  0x600e0010<br> R8    0x00000000<br> R9    0xbbdf8c18<br> R10   0xbbdf8b80<br> R11   0xbbdf8b90<br> R12   0xf3811ce8<br> LR    0xc8b69787<br> R0    0xbbdf8b70<br> R1    0x05c43127<br> R2    0x05c43127<br> R3    0x05c43127<br> R4    0xf3813260<br> R5    0xbbdf8b70<br> R6    0xdcc854b8<br> R7    0xbbdf8b88<br>#################### Hook end ##############################<br>1.8.12</p>
</blockquote>
<p>The hook handle function just do the following,</p>
<ul>
<li>print base address </li>
<li>dump values of all registers stored in the stack</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>This method still has many way to improve. And it only support Thumb. If you have any idea or issues, please feel free to let me know. I’m always glad to hack and discuss with others.<br>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a>.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-27T01:34:16.000Z" title="6/27/2022, 9:34:16 AM">2022-06-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">8 minutes read (About 1251 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/27/How-to-use-CMoudule-in-Frida/">How to use CModule in Frida</a></p><div class="content"><p>In this article, I will try to introduce how to use CModule in Frida.<br>My test Android APK is a small game, named “Knife hit”, you can download it from <a target="_blank" rel="noopener" href="https://apkpure.com/knife-hit/com.ketchapp.knifehit">APKpure website</a>. This is a Cocos2d game, it has a native library named ‘libMyGame.so’. This library file has many game logic codes. It exports many functions. We will try to call one of them to get Cocos2d application version and print out it. </p>
<h1 id="Why-typescript"><a href="#Why-typescript" class="headerlink" title="Why typescript?"></a>Why typescript?</h1><p>Later version of Frida support typescript. And Frida provides a <a target="_blank" rel="noopener" href="https://github.com/oleavr/frida-agent-example.git">demo</a> for starting of typescript coding. It use a NPM package, ‘<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/frida-compile">frida-compile</a>‘, for compiling of typescript code. Using typescript needs a compilation, it might take longer time to test the code, but we can avoid many issues in compilation. So I prefer typescript. </p>
<h1 id="What-is-a-CMoudule"><a href="#What-is-a-CMoudule" class="headerlink" title="What is a CMoudule"></a>What is a CMoudule</h1><p>This is its <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#cmodule">official documentation</a>. In my option, we can write some functions in C, and Frida provides a way to invoke these functions. The following is the example in the official documentation.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void hello(void) &#123;</span></span><br><span class="line"><span class="string">  printf(&quot;Hello World from CModule\\n&quot;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(cm));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(cm.<span class="property">hello</span>, <span class="string">&#x27;void&#x27;</span>, []);</span><br><span class="line"><span class="title function_">hello</span>();</span><br></pre></td></tr></table></figure>
<p>Line 1-7 create a CModule, it includes C code, and exports one function, ‘hello’ to print a welcome string.<br>Line 9 displays the information of the CModule. Frida is very smart, the C code should be compiled in here. And Frida should load the CModule in the memory space of the target process.<br>Line 11 convert function pointer to a NativeFunction for calling in Frida. So, cm.hello just is a NativePoiner.<br>Line 12 call hello function</p>
<h1 id="Write-our-own-CModule"><a href="#Write-our-own-CModule" class="headerlink" title="Write our own CModule"></a>Write our own CModule</h1><h2 id="Why-not-to-use-printf"><a href="#Why-not-to-use-printf" class="headerlink" title="Why not to use printf?"></a>Why not to use printf?</h2><p>Typescript code and C code is actually run in the target process’ memory space. And Android process usually do not use printf. They use <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/reference/group/logging#__android_log_print">__android_log_print</a> instead. But this function do not print message to Frida, we nee to run <code>adb logcat</code> to check its output. It’s not very convenience. We can write some functions in typescript to let C code to call.</p>
<h2 id="Typescript-functions-for-debugging"><a href="#Typescript-functions-for-debugging" class="headerlink" title="Typescript functions for debugging"></a>Typescript functions for debugging</h2><p>I wrote several helper functions in typescript, I put them in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/fridautilts.ts">fridautils.ts</a>.</p>
<h3 id="frida-log-callback"><a href="#frida-log-callback" class="headerlink" title="frida_log_callback"></a>frida_log_callback</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> frida_log_callback = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">sp:NativePointer</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> s = sp.<span class="title function_">readUtf8String</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>This function has one argument of type NativePointer. C code passes a pointer to a string to this function.<br>Line 2 read a string from given address.<br>Line 3 outputs the string to Frida.</p>
<h3 id="frida-log-cstring-callback"><a href="#frida-log-cstring-callback" class="headerlink" title="frida_log_cstring_callback"></a>frida_log_cstring_callback</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> frida_log_cstring_callback = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">pString:NativePointer</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> s = pString.<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readPointer</span>().<span class="title function_">readUtf8String</span>(); <span class="comment">// get string to a pointer to a std::string object</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>Cocos2D stores the version string in a std::string. So we needs a function to extract the actual string from the std::string object and print it.<br>This function has only one argument, it also is of type NativePoiner, but it should be a pointer to a std::string object<br>Line 2 extracts the actual string from the given std::string object. Note: Android developers can specify different variable in their <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/application_mk">Application.mk</a> file. Variables APP_ABI, APP_STL may determine different implementations of std::string class. So current method to extract a string may not work correctly when you hack other Android APKs.<br>Line 3 outputs extracted string to Frida.</p>
<h2 id="Our-own-CModule"><a href="#Our-own-CModule" class="headerlink" title="Our own CModule"></a>Our own CModule</h2><p>I wrote a CModule to show the Cocos2D application version string by using the functions has exist in libMyGame.so. I put code it file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/cmoduletest.ts">cmoduletest.ts</a>.</p>
<h3 id="Cocos2d-functions-for-get-version-string"><a href="#Cocos2d-functions-for-get-version-string" class="headerlink" title="Cocos2d functions for get version string"></a>Cocos2d functions for get version string</h3><p>I read the <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.0rc2/db/de2/classcocos2d_1_1_application.html">official documentation</a> in Cocos2d website. Class cocos2d::Application has 2 function we can use:</p>
<ul>
<li>static Application* getInstance 	()<br>  <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.0rc2/db/de2/classcocos2d_1_1_application.html#aa98b8f5621b53c808429f5dde0662921">doc</a><br>  This function return a pointer to the current application instance.</li>
<li>const std::string&amp; getVersion () const<br>  <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.3rc0/dc/db1/classcocos2d_1_1extension_1_1_manifest.html#aad022179566240a5612dfa964152d704">doc</a><br>  This function return a std::string reference to the version string. A C++ reference is a pointer in machine code actually.</li>
</ul>
<h3 id="Call-Cocos2d-functions"><a href="#Call-Cocos2d-functions" class="headerlink" title="Call Cocos2d functions"></a>Call Cocos2d functions</h3><p>The following is the code </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test0 = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> soname =<span class="string">&quot;libMyGame.so&quot;</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(soname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> loadm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        void* _ZN7cocos2d11Application11getInstanceEv ();</span></span><br><span class="line"><span class="string">        const char* _ZN7cocos2d11Application10getVersionEv(void*);</span></span><br><span class="line"><span class="string">        extern void frida_log_callback(const char* s);</span></span><br><span class="line"><span class="string">        extern void frida_log_cstring_callback(void*);</span></span><br><span class="line"><span class="string">        void fun(void) &#123;</span></span><br><span class="line"><span class="string">            frida_log_callback(&quot;Hello World from CModule&quot;);</span></span><br><span class="line"><span class="string">            void* pApplication = _ZN7cocos2d11Application11getInstanceEv();</span></span><br><span class="line"><span class="string">            const char* version = _ZN7cocos2d11Application10getVersionEv(pApplication);</span></span><br><span class="line"><span class="string">            frida_log_callback(&quot;cocos2d application version: &quot;);</span></span><br><span class="line"><span class="string">            frida_log_cstring_callback((void*)version);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      frida_log_callback  : fridautils.<span class="property">frida_log_callback</span>,</span><br><span class="line">      frida_log_cstring_callback  : fridautils.<span class="property">frida_log_cstring_callback</span>,</span><br><span class="line">      <span class="comment">// cocos2d::Application::getInstance</span></span><br><span class="line">      <span class="comment">// use this static function  to get a pointer to the current Application instance</span></span><br><span class="line">      _ZN7cocos2d11Application11getInstanceEv : m.<span class="title function_">getExportByName</span>(<span class="string">&quot;_ZN7cocos2d11Application11getInstanceEv&quot;</span>), </span><br><span class="line">      <span class="comment">// const char* cocos2d::Application::getVersion(void*)</span></span><br><span class="line">      <span class="comment">// use this member function of class Application to get a version string </span></span><br><span class="line">      <span class="attr">_ZN7cocos2d11Application10getVersionEv</span>: m.<span class="title function_">getExportByName</span>(<span class="string">&quot;_ZN7cocos2d11Application10getVersionEv&quot;</span>), </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(loadm));</span><br><span class="line">    fridautils.<span class="title function_">runFunWithExceptHandling</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(loadm.<span class="property">fun</span>, <span class="string">&#x27;void&#x27;</span>,[])</span><br><span class="line">        <span class="title function_">fun</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Line 6-16 is the C code.<br>Line 6-7 declares the Cocos2d functions we will using. Because we are in C, so we only can use mangled function names.<br>Line 8-9 declares the helper functions we created in Typescript.<br>Line 10-16, we create a function named <code>fun</code> to do our actual work<br>Line 12, we get the current application instance address using function cocos2d::Application::getInstance, this function is a static function, and it has no argument, we store the result to variable <code>pApplication</code>;<br>Line 13, we get a pointer to a std::string object  using function cocos2d::Application::getVersion, this function is a member function, and it needs a <code>this</code> pointer as its first argument. We just pass variable <code>pApplication</code> to it.<br>Line 14-15. We print version string using helper functions.<br>LIne 19-26. We needs to pass all functions to the CModule using a dictionary. In the dictionary,  key is the function name, and value is the function address.  We call Module.getExportByName to get the functions address in the libMyGame.so</p>
<h2 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h2><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following cmd to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_cmoduletest</span><br></pre></td></tr></table></figure>
<p>And use the following cmd to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows</p>
<blockquote>
<p>Hello World from CModule<br>cocos2d application version:<br>1.8.12<br>This game’s Cocos2d application version is <code>1.8.12</code></p>
</blockquote>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Now, we know how to call the existing functions using CModule. Cocos2D exports a lot of functions in its native library file. We can do many things using these functions.<br>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-25T07:23:24.000Z" title="6/25/2022, 3:23:24 PM">2022-06-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">5 minutes read (About 734 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/25/Frida-android-basic/">Frida Android basics</a></p><div class="content"><p>This article introduces the basics about how to use Frida on Android platform.</p>
<h1 id="About-Frida"><a href="#About-Frida" class="headerlink" title="About Frida"></a>About Frida</h1><p><a target="_blank" rel="noopener" href="https://frida.re/">Frida</a> is a great tool working on Windows, macOS and GNU&#x2F;Linux allowing you to inject snippets of code into native apps. In this tutorial we’ll use Frida to inject code into Android applications.</p>
<p>Frida has 2 work modes, one is client-server, the other is gadget mode.</p>
<h2 id="Server-mode"><a href="#Server-mode" class="headerlink" title="Server mode"></a>Server mode</h2><p>The server runs on the Android phone and the client on your computer. Note that you need a phone or an Android emulator that rooted.</p>
<h4 id="Frida-installation"><a href="#Frida-installation" class="headerlink" title="Frida installation"></a>Frida installation</h4><p>Installing Frida on your computer is a super easy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install frida-tools</span><br></pre></td></tr></table></figure>
<p>Note that the latest Python 3 is recommended. Lets check which version is installed:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frida --version</span><br></pre></td></tr></table></figure>
<p>And we need to find the architecture of you phone.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell getprop ro.product.cpu.abi</span><br></pre></td></tr></table></figure>
<p>Now, we need to install the server on our Android phone. Visit <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida release</a> page, and find a file named like “frida-server-XX.XX.XX-android-YYYY.xz”. ‘XX.XX.XX’ is the version of your installed frida, and YYYY is the architecture of your Android device. Note frida server version should be better to match the frida version on you computer.<br>We uncompress the archive and rename the server to “frida-server”<br>And install the server on the phone:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ adb root <span class="comment"># might be required</span></span><br><span class="line">$ adb push frida-server /data/local/tmp/</span><br><span class="line">$ adb shell <span class="string">&quot;chmod 777 /data/local/tmp/frida-server&quot;</span></span><br></pre></td></tr></table></figure>
<p>Now try to start the server.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell <span class="string">&quot;/data/local/tmp/frida-server &amp;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="Frida-test"><a href="#Frida-test" class="headerlink" title="Frida test"></a>Frida test</h3><p>Run the following command to list all applications on your Android device:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -Uai</span><br></pre></td></tr></table></figure>
<h2 id="Gadget-mode"><a href="#Gadget-mode" class="headerlink" title="Gadget mode"></a>Gadget mode</h2><p>This mode needs not a rooted android device, but need to repackage APKs you wnat to hack.</p>
<h3 id="Download-Gadget-file"><a href="#Download-Gadget-file" class="headerlink" title="Download Gadget file"></a>Download Gadget file</h3><p>Also visit <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida release</a> page, and find a file named like “frida-gadget-XX.XX.XX-android-YYYY.so.xz”. ‘XX.XX.XX’ is the version of your installed frida, and YYYY is the architecture of your Android device.<br>We uncompress the archive and rename the so to “libgadget.so”</p>
<h3 id="Inject-libgadget-so-to-your-APK"><a href="#Inject-libgadget-so-to-your-APK" class="headerlink" title="Inject libgadget.so to your APK"></a>Inject libgadget.so to your APK</h3><p>Try to find any native library file in you APK, and inject libgadget.so to it.<br>The following is a Python script to inject libgadget.so, just add libgadget.so as a dependency of a native libraries embedded in the APK.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief <span class="comment"># you can install lief package with `pip install lief`</span></span><br><span class="line">libnative = lief.parse(<span class="string">&quot;libnative.so&quot;</span>) <span class="comment"># you should replace libnative.so to you actual so file name</span></span><br><span class="line">libnative.add_library(<span class="string">&quot;libgadget.so&quot;</span>) <span class="comment"># Injection!</span></span><br><span class="line">libnative.write(<span class="string">&quot;libnative.so&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Write-a-gadget-config-file"><a href="#Write-a-gadget-config-file" class="headerlink" title="Write a gadget config file"></a>Write a gadget config file</h3><p>Create a file name with ‘libgadget.config.so’. and put the following content in it:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;interaction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;listen&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;on_load&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wait&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>And copy this file into same directory with your patched libnative.so in. </p>
<h3 id="Repackage-APK-file"><a href="#Repackage-APK-file" class="headerlink" title="Repackage APK file"></a>Repackage APK file</h3><p>There are many APK repackage utils. I prefer <a target="_blank" rel="noopener" href="https://forum.xda-developers.com/t/discontinued-windows-apk-easy-tool-v1-60-2022-06-23.3333960/">APK easy Tool</a></p>
<h3 id="Frida-test-1"><a href="#Frida-test-1" class="headerlink" title="Frida test"></a>Frida test</h3><p>If you install patched APK to your Android device and open it.<br>The app seems it sucks, don’t be worry, it’s waiting for you to run frida client to connect it.<br>Run the following command, you will find a process with a name ‘Gadget’.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -Uai</span><br></pre></td></tr></table></figure>
<p>This process just is your patched APK, and we can not see other applications, because we’re not root now</p>
<h2 id="Getting-started-with-Frida"><a href="#Getting-started-with-Frida" class="headerlink" title="Getting started with Frida"></a>Getting started with Frida</h2><h3 id="Write-a-javascript-file-you-want-to-inject"><a href="#Write-a-javascript-file-you-want-to-inject" class="headerlink" title="Write a javascript file you want to inject"></a>Write a javascript file you want to inject</h3><p>The content of the test javascript file (named tt.js)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Inject-javascript-code-to-an-Android-process"><a href="#Inject-javascript-code-to-an-Android-process" class="headerlink" title="Inject javascript code to an Android process"></a>Inject javascript code to an Android process</h3><p>Frida provides serval utils to let us life easy. One of them is ‘frida’.<br>Run the following command to connect to your wait process in gadget mode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -n Gadget -l tt.js --no-pause </span><br></pre></td></tr></table></figure>
<p>You will see a frida shell, and it print ‘hello world’<br>For client&#x2F;server mode, you should run frida with other options:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f &lt;package name&gt; -l tt.js --no-pause  # this command will reopen your app</span><br></pre></td></tr></table></figure>
<p>or </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -n &lt;app title&gt; -l tt.js --no-pause  # this command do not reopen your app</span><br></pre></td></tr></table></figure>


<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Now we can inject a basic javascript code into an Android app, you can refer <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">frida Javascript documentation</a> for more learning.</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Meng Xipeng"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Meng Xipeng</p><p class="is-size-6 is-block">Reverse engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/mengxipeng1122" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/meng_xi_peng"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-22T07:22:24.000Z">2024-01-22</time></p><p class="title"><a href="/2024/01/22/Mastering-Frida-A-Guide-to-Fixing-Early-Instrumentation-in-Gadget-Mode/">Mastering Frida: A Guide to Fixing Early Instrumentation in Gadget Mode</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-07T08:42:04.000Z">2024-01-07</time></p><p class="title"><a href="/2024/01/07/How-to-indentify-NDK-version-of-a-so/">Identifying the NDK Version of a .so File</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-28T00:41:13.000Z">2023-10-28</time></p><p class="title"><a href="/2023/10/28/Hacking-Cocos2D-Android-Games-using-Frida/">Hacking Cocos2D Android Games using Frida</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-31T07:24:00.000Z">2023-08-31</time></p><p class="title"><a href="/2023/08/31/Hacking-Android-game-using-Frida-Part3/">Hacking Android Game using Frida - Part3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-29T06:53:23.000Z">2023-08-29</time></p><p class="title"><a href="/2023/08/29/Hacking-Android-game-using-Frida-Part2/">Hacking Android game using Frida - Part2</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ARM/"><span class="tag">ARM</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CModule/"><span class="tag">CModule</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos2d/"><span class="tag">Cocos2d</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Frida/"><span class="tag">Frida</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Game/"><span class="tag">Game</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hack/"><span class="tag">Hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hacking/"><span class="tag">Hacking</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Inline-hook/"><span class="tag">Inline hook</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse/"><span class="tag">Reverse</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-engineering/"><span class="tag">Reverse engineering</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thumb/"><span class="tag">Thumb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hack/"><span class="tag">hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hacking/"><span class="tag">hacking</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inlinehook/"><span class="tag">inlinehook</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Meng Xipeng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>