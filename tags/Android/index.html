<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: Android - Meng Xipeng&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Meng Xipeng&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Meng Xipeng&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Meng Xipeng&#039;s blog"><meta property="og:url" content="http://mengxipeng1122.github.io/"><meta property="og:site_name" content="Meng Xipeng&#039;s blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://mengxipeng1122.github.io/img/og_image.png"><meta property="article:author" content="Meng Xipeng"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://mengxipeng1122.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://mengxipeng1122.github.io"},"headline":"Meng Xipeng's blog","image":["http://mengxipeng1122.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Meng Xipeng"},"publisher":{"@type":"Organization","name":"Meng Xipeng's blog","logo":{"@type":"ImageObject","url":"http://mengxipeng1122.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">Android</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-01-07T08:42:04.000Z" title="1/7/2024, 4:42:04 PM">2024-01-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-07T09:55:08.552Z" title="1/7/2024, 5:55:08 PM">2024-01-07</time></span><span class="level-item">2 minutes read (About 316 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/01/07/How-to-indentify-NDK-version-of-a-so/">Identifying the NDK Version of a .so File</a></p><div class="content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This blog post aims to provide a method for accurately identifying the version of the NDK (Native Development Kit) used in a .so file within the Android platform.</p>
<h1 id="Methodology"><a href="#Methodology" class="headerlink" title="Methodology"></a>Methodology</h1><p>In certain situations, it becomes necessary to confirm the specific NDK version utilized in the .so files of an APK. Once achieve this, we can compile our own binary code using the same NDK version and subsequently patch the resulting binary into the .so files in order to accomplish our objectives. It is crucial to note that using a different version of the NDK may lead to ABI (Application Binary Interface) incompatibility issues with our binary.</p>
<h1 id="Test-Case-“Rise-of-Saiyan”-Android-Game"><a href="#Test-Case-“Rise-of-Saiyan”-Android-Game" class="headerlink" title="Test Case: “Rise of Saiyan” Android Game"></a>Test Case: “Rise of Saiyan” Android Game</h1><p>For the purpose of illustration, we will employ the Android game called “Rise of Saiyan.” You may download the game from the following link: <a target="_blank" rel="noopener" href="https://en.riseofsaiyan.com/home.php">Rise of Saiyan</a>. Within this game, there exists a shared library file named libcocos2dlua.so.</p>
<h2 id="Locating-the-Magic-Word"><a href="#Locating-the-Magic-Word" class="headerlink" title="Locating the Magic Word"></a>Locating the Magic Word</h2><p>The initial step involves finding the magic word, which in this case is “Android”. We can accomplish this by executing the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ strings -tx libcocos2dlua.so | grep <span class="string">&quot;Android$&quot;</span></span><br><span class="line">13ab850 Android</span><br></pre></td></tr></table></figure>
<p>As demonstrated, we successfully discovered the magic word located at offset 0x13ab850.</p>
<h2 id="Extracting-the-NDK-Version-String"><a href="#Extracting-the-NDK-Version-String" class="headerlink" title="Extracting the NDK Version String"></a>Extracting the NDK Version String</h2><p>Next, we proceed to extract the NDK version string by hexdumping the content beginning from the identified offset:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexdump -C -n 30 -s $((<span class="number">0</span>x13ab850)) libcocos2dlua.so</span><br><span class="line">013ab850  41 6e 64 72 6f 69 64 00  15 00 00 00 72 32 31 65  |Android.....r21e|</span><br><span class="line">013ab860  00 00 00 00 00 00 00 00  00 00 00 00 00 00        |..............|</span><br><span class="line">013ab86e</span><br></pre></td></tr></table></figure>
<p>By analyzing the hexdump, we successfully identified the NDK version string as r21e. This information allows us to download the corresponding NDK version.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In conclusion, this blog post presents a straightforward method for identifying the NDK version string within a .so file. By following the outlined steps, developers can accurately determine the NDK version and proceed with their required tasks effectively and efficiently.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-10-28T00:41:13.000Z" title="10/28/2023, 8:41:13 AM">2023-10-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-07T08:39:54.134Z" title="1/7/2024, 4:39:54 PM">2024-01-07</time></span><span class="level-item">14 minutes read (About 2125 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/10/28/Hacking-Cocos2D-Android-Games-using-Frida/">Hacking Cocos2D Android Games using Frida</a></p><div class="content"><h1 id="Disclaimer"><a href="#Disclaimer" class="headerlink" title="Disclaimer"></a>Disclaimer</h1><p>Please note that the information provided in this blog post is intended for educational and informational purposes only. Any application of the techniques and tools mentioned in this post must be carried out responsibly and in accordance with local and international regulations and laws.</p>
<p>Attempting to hack software, including games, without express permission from the owners is strictly illegal and unethical. The author and the publishers of this blog do not condone, encourage or endorse any illegal activity, and any actions taken based on the contents of this blog will be solely at your own risk.</p>
<p>We strongly encourage readers to use this information to enhance their understanding of the underlying mechanisms of software and to promote improved security, rather than for ulterior purposes. This blog, its author, and its publishers bear no responsibility for misuse of the information provided.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Hey there! Ever wondered how exciting it would be to peek under the hood of your favorite Android games, particularly the ones built using cocos2d? Well, this blog post will walk you through just that. But we’re not talking about cheats or shortcuts, we’re diving into game hacking — the good kind.</p>
<p>First off, why cocos2d? It’s a user-friendly, open-source software perfect for building games. On the other hand, Frida is a programmer’s secret weapon, akin to a multi-tool. It’s a powerful toolkit that allows you to weave your code seamlessly into an already-running process. This incredible ability to inject and inspect code in real-time, without causing a ruckus, makes Frida an essential instrument for any coder’s toolbelt.</p>
<p>Now, don’t worry if you aren’t a coding whiz. This guide is meant for anyone curious about how games work. A basic grip on the Android system, a touch of Typescript, a little bit of C++ and a whole lot of enthusiasm are all you need to level up. Ready for the ride? Let’s get started!</p>
<h1 id="Create-C-module-for-hacking"><a href="#Create-C-module-for-hacking" class="headerlink" title="Create C++ module for hacking"></a>Create C++ module for hacking</h1><p>To illustrate, I make use of a 2D game. This game adopts a unique format, defined by its developers, to house its animations. The asset files associated are denoted with a .ROM extension.</p>
<p>Each of these asset files can encompass multiple actions. In turn, each action is made up of several steps. Intriguingly, each step in this context represents an image. These images, which constitute the steps, might exhibit differing dimensions.</p>
<p>I plan on developing a C++ module that can be injected into the process for hacking. A detailed outline of this procedure can be found on <a href="http://mengxipeng1122.github.io/2022/12/24/frida-mod-tutorial/">my blog post</a>.</p>
<h1 id="Static-analysis"><a href="#Static-analysis" class="headerlink" title="Static analysis"></a>Static analysis</h1><p>Static analysis, also known as code review, is the process of examining source code without executing it, focusing instead on its structure, dependencies, and patterns. It is a widely accepted preliminary step in understanding the functionality of any software or application, including games built on frameworks like cocos2d.</p>
<p>Begin by familiarizing yourself with the cocos2d framework. Cocos2d is an open-source software development kit for developing games and other graphical applications. I can get cocos2d’s code from here: <a target="_blank" rel="noopener" href="https://github.com/cocos2d/cocos2d-x">github.com&#x2F;cocos2d&#x2F;cocos2d-x</a>.</p>
<p>Thoroughly reviewing the source code of the framework greatly benefits our endeavor to understand software in-depth, an essential step for ethical hacking. However, we should acknowledge that the openness of open-source platforms does present a double-edged sword. Despite its numerous advantages, it also opens a gateway for potential misuse. The exposure of the source code presents an intimate understanding of a software’s underlying mechanisms, which, while essential for improving and learning, can be exploited if it falls into the wrong hands.Reviewing the framework source code is very helpful for our hacking work. So I should say open source has its dark side. source code provides valuable insight into the underlying mechanisms of software.</p>
<h2 id="Extracting-information-from-binary"><a href="#Extracting-information-from-binary" class="headerlink" title="Extracting information from binary"></a>Extracting information from binary</h2><p>Typically, Android games developed using the Cocos2D framework incorporate a shared library known as libcocos2dcpp.so. This integral component houses the core logic underlying the game’s operations and interactions, serving as a centerpiece for the game’s design and execution.<br>I plan to conduct a detailed examination of this file in order to glean more comprehensive insights about the underlying mechanics of this Android game. This in-depth analysis will allow me to understand its structure and functionality more precisely.</p>
<h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file libcocos2dcpp.so</span><br><span class="line">libcocos2dcpp.so: ELF 32-bit LSB shared object, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /system/bin/linker, stripped</span><br></pre></td></tr></table></figure>
<p>The result derived from executing the <code>file</code> command implies that the file is an ELF file, and is a ARM32 archtecture.</p>
<h3 id="Ghidra"><a href="#Ghidra" class="headerlink" title="Ghidra"></a>Ghidra</h3><p>I utilized Ghidra for analyzing the shared library under examination. This comprehensive software reverse-engineering tool revealed that the library exports numerous symbols that can be invoked. A symbol that particularly caught our attention is <code>_ZN7cocos2d14cocos2dVersionEv</code>. This symbol is associated with a C++ function <code>cocos2d::cocos2dVersion()</code>.</p>
<p>However, it’s important to note that the symbol name only provides information about the function’s namespace, name, and argument types. We can’t ascertain the return type solely from the symbol’s name. Fortunately though, we have access to the source code. By cross-referencing the function within the source code, I was able to determine that its return type is <code>char*</code>.</p>
<p>The following code illustrates the cocos2d version is <code>cocos2d-x 3.3rc0</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> cocos2d &#123;</span><br><span class="line">    <span class="function"><span class="type">char</span>* <span class="title">cocos2dVersion</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">&quot; Cocos2d version: %s&quot;</span>,  cocos2d::<span class="built_in">cocos2dVersion</span>());</span><br></pre></td></tr></table></figure>
<p>Once we precisely identify the version of the Cocos2d framework being used, it opens up the possibility to retrieve the exactly corresponding version of the source code. </p>
<h2 id="Define-C-classes"><a href="#Define-C-classes" class="headerlink" title="Define C++ classes"></a>Define C++ classes</h2><p>In the process of extracting images from asset files, I lean on the capabilities of a particular C++ class called <code>ActionGroupClass</code> during the Ghidra analysis phase. This class not only streamlines the extraction process but also boasts of several utility methods.<br>The following is the class define I infered from Ghidra</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> cocos2d&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Texture2D</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ActionGroupClass</span>&#123;                                                                                                                     </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _0x0[<span class="number">0x102</span>];                                                                                                               </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> _totalActionCount;                                                                                                         </span><br><span class="line">    <span class="built_in">ActionGroupClass</span>();                                                                                                                      </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">vQuickLoad</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">bool</span>, <span class="type">int</span>, <span class="type">int</span>)</span></span>;                                                                                         </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">vGetBaseXY</span><span class="params">(<span class="type">short</span>, <span class="type">float</span>*, <span class="type">float</span>*)</span></span>;                                                                                                  </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">GetTotalStep</span><span class="params">(<span class="type">short</span>)</span></span>;                                                                                                                 </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">vGetVectorXY</span><span class="params">(<span class="type">short</span>, <span class="type">short</span>, <span class="type">short</span>*, <span class="type">short</span>*)</span></span>;                                                                                         </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">GetPictureIndex</span><span class="params">(<span class="type">short</span>, <span class="type">short</span>, <span class="type">unsigned</span> <span class="type">char</span>*)</span></span>;                                                                                      </span><br><span class="line">    ~<span class="built_in">ActionGroupClass</span>();                                                                                                                     </span><br><span class="line">    <span class="function">cocos2d::Texture2D* <span class="title">GetTexture2DwithAction</span><span class="params">(<span class="type">short</span>, <span class="type">short</span>)</span></span>;                                                                                </span><br><span class="line">&#125;;                                                                                                                                           </span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">offsetof</span>(ActionGroupClass, _totalActionCount) ==<span class="number">0x102</span>, <span class="string">&quot;_totalActionCount not at offset 0x102&quot;</span>);             </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This class, <code>ActionGroupClass</code>, is designed and implemented by game developers, which means it isn’t found directly within the Cocos2D framework.<br>Game developers have also defined several global variables, each of which is of the <code>ActionGroupClass</code> type. These variables are utilized throughout the game for various purposes, depending on the specific characteristics and methods defined within the ActionGroupClass.<br>We can utilize these global variables to extract images from asset files. In addition, the shared library should contain code within the .init section. This code is responsible for calling the constructor method of the ActionGroupClass on these global variables. This initialization is essential in setting up the initial state for these global instances.<br>In addition, modern C++ provides a way to call a constructor on an already allocated memory. This is called placement new. Here’s how it works:<br>In C++, the new keyword typically allocates memory and then constructs an object in the allocated memory. However, there are times when you want to separate these two operations. For example, when you have already allocated memory and just want to construct an object at that memory location you can use “placement new”.<br>Here is the general syntax:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;new&gt;</span></span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>* p = (<span class="type">unsigned</span> <span class="type">char</span>*)&amp;FishActionGroup;                                                                                              </span><br><span class="line">    <span class="keyword">auto</span>* fishActionGroup = <span class="built_in">new</span>((<span class="type">void</span>*)p) <span class="built_in">ActionGroupClass</span>();   </span><br></pre></td></tr></table></figure>
<p>We can use this way to call constructor method in these global variables.</p>
<h1 id="Dynamic-analysis"><a href="#Dynamic-analysis" class="headerlink" title="Dynamic analysis"></a>Dynamic analysis</h1><p>Dynamic analysis involves the live examination of a system while it’s operational. In terms of hacking a cocos2d Android game using the Frida toolkit, dynamic analysis enables us to inspect and alter the game while it’s being actively played. This can provide insights that are not available during static analysis—when the program or game is not running.</p>
<h2 id="Read-string-for-a-pointer-to-std-string"><a href="#Read-string-for-a-pointer-to-std-string" class="headerlink" title="Read string for a pointer to std::string."></a>Read string for a pointer to std::string.</h2><p>When dealing with the Android NDK, there are numerous elements involved when implementing the Standard Template Library (STL). Since I’m utilizing a recent version of the NDK, the conventional method of extracting a string from a std::string variable using std::string::c_str() is unfortunately not applicable. Hence, a different approach is needed. After a detailed analysis of the memory layout connected to a std::string variable within the process, I have developed the following function to accurately extract the required string.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">getStringCStr</span><span class="params">(std::string&amp; str)</span></span>&#123;                                                                                                 </span><br><span class="line">    <span class="keyword">auto</span>* p = (<span class="type">unsigned</span> <span class="type">char</span>*) &amp;str;                                                                                                         </span><br><span class="line">    <span class="keyword">auto</span>* s= *(<span class="type">char</span>**)&amp;p[<span class="number">0x00</span>];                                                                                                              </span><br><span class="line">    <span class="keyword">return</span> s;                                                                                                                                </span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h2 id="Get-RTTI"><a href="#Get-RTTI" class="headerlink" title="Get RTTI"></a>Get RTTI</h2><p>The shared library has been configured with Run-Time Type Information (RTTI) enabled. This setup allows us to extract RTTI using a pointer referring to a class directly. To streamline this process, I have authored the subsequent function specifically tailored for this task.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">getInstanceTypeName</span><span class="params">(<span class="type">void</span>* ptr)</span></span>&#123;                                                                                                      </span><br><span class="line">    <span class="type">void</span>**  p = *(<span class="type">void</span>***)ptr;                                                                                                                   </span><br><span class="line">    std::type_info&amp; t =*(std::type_info*)p[<span class="number">-1</span>];                                                                                                  </span><br><span class="line">    <span class="keyword">return</span> t.<span class="built_in">name</span>();                                                                                                                             </span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<h2 id="Extract-images-from-a-asset-file"><a href="#Extract-images-from-a-asset-file" class="headerlink" title="Extract images from a asset file"></a>Extract images from a asset file</h2><p>Moving forward, let’s deftly invoke the inherent functions of our key class, <code>ActionGroupClass</code>, to systematically acquire all pertinent information concerning the graphic elements.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">char</span>* romdata =  <span class="built_in">read_file_into_memory</span>(<span class="string">&quot;/data/local/tmp/weapon1.rom&quot;</span>) ;                                                                      </span><br><span class="line"> <span class="keyword">if</span>(romdata)&#123;                                                                                                                                 </span><br><span class="line">     <span class="built_in">LOG_INFOS</span>(<span class="string">&quot;%p&quot;</span>, romdata);                                                                                                                </span><br><span class="line">     fishActionGroup-&gt;<span class="built_in">vQuickLoad</span>((<span class="type">unsigned</span> <span class="type">char</span>*)romdata, <span class="literal">true</span>, <span class="number">30</span>, <span class="number">30</span>);                                                                      </span><br><span class="line">     <span class="built_in">free</span>(romdata);                                                                                                                           </span><br><span class="line">     romdata = <span class="literal">NULL</span>;                                                                                                                          </span><br><span class="line">     <span class="keyword">auto</span> totalActionCount = fishActionGroup-&gt;_totalActionCount;                                                                              </span><br><span class="line">     <span class="built_in">LOG_INFOS</span>(<span class="string">&quot; totalActionCount %d&quot;</span>, totalActionCount);                                                                                     </span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">auto</span> action=<span class="number">0</span>; action&lt;totalActionCount; action++)&#123;                                                                                   </span><br><span class="line">         <span class="keyword">auto</span> totalStep = fishActionGroup-&gt;<span class="built_in">GetTotalStep</span>(action);                                                                              </span><br><span class="line">         <span class="type">float</span> x, y;                                                                                                                          </span><br><span class="line">         fishActionGroup-&gt;<span class="built_in">vGetBaseXY</span>(action, &amp;x, &amp;y);                                                                                         </span><br><span class="line">         <span class="built_in">LOG_INFOS</span>(<span class="string">&quot; action %d ,total step %d %f %f &quot;</span>, action, totalStep, x, y );                                                             </span><br><span class="line">         <span class="type">short</span> stepx, stepy;                                                                                                                  </span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">auto</span> step = <span class="number">0</span>; step &lt; totalStep; step++)&#123;                                                                                        </span><br><span class="line">             fishActionGroup-&gt;<span class="built_in">vGetVectorXY</span>(action, step, &amp;stepx, &amp;stepy);                                                                     </span><br><span class="line">             <span class="type">unsigned</span> <span class="type">char</span> pic;                                                                                                               </span><br><span class="line">             <span class="keyword">auto</span> success = fishActionGroup-&gt;<span class="built_in">GetPictureIndex</span>(action, step, &amp;pic);                                                             </span><br><span class="line">             <span class="built_in">LOG_INFOS</span>(<span class="string">&quot; action %d/%d step %d/%d base %f %f step %d %d pic %d &quot;</span>, action, totalActionCount, step, totalStep, x, y, stepx, stepy, pic);                                                                                                                                          </span><br><span class="line">             <span class="keyword">auto</span>* tex = fishActionGroup-&gt;<span class="built_in">GetTexture2DwithAction</span>(action, step);                                                               </span><br><span class="line">             <span class="keyword">auto</span> w = tex-&gt;<span class="built_in">getPixelsWide</span>();                                                                                                   </span><br><span class="line">             <span class="keyword">auto</span> h = tex-&gt;<span class="built_in">getPixelsHigh</span>();                                                                                                   </span><br><span class="line">             <span class="keyword">auto</span>* format = tex-&gt;<span class="built_in">getStringForFormat</span>();                                                                                        </span><br><span class="line">             <span class="built_in">LOG_INFOS</span>(<span class="string">&quot; action %d/%d step %d/%d texture %p %d %d %s&quot;</span>, action, totalActionCount, step, totalStep, tex, w, h, format);         </span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>Here’s an illustrative breakdown of its operations:</p>
<p>The first segment is devoted to reading a ROM file, specifically ‘weapon1.rom’, and storing it into memory. The in-memory address of this acquired data is logged for debugging purposes.</p>
<p>Next, the vQuickLoad method of fishActionGroup, an instance of ActionGroupClass, is invoked. This quickly loads in the binary content from the ROM data into our action group. Meanwhile, the parameters ‘30’ represent the default size in pixels for each sprite in the action.</p>
<p>The memory allocated to ‘romdata’ is subsequently cleared using ‘free’ to prevent memory leaks, and its pointer is nullified for safety.</p>
<p>Thereafter, we acquire the total count of actions stored within our action group by calling the _totalActionCount function. For every action, two tasks are performed: Firstly, the total number of steps related to that action are gathered. Secondly, the base coordinates (x, y) for that action are obtained via vGetBaseXY.</p>
<p>Each step per action is scrutinized next. This includes determining its directional vector (stepx, stepy) and the picture index related to each step. Moreover, the texture associated with each step of the action is also retrieved.</p>
<p>Finally, this section delves into extracting comprehensive details about said texture: the dimensions (width and height in pixels) and the format. This information, alongside other relevant details, is logged for every step in every action.</p>
<p>This meticulous process guarantees a thorough understanding of the movements, graphical elements, sizes, and properties involved, which immensely aids in manipulating or changing game assets for your desired outcome as part of your game hacking initiative.<br>After obtaining the pointers to <code>Texture2D</code>, it becomes possible to invoke the built-in functions within the class to save the graphic data to disk. However, elaborating on the specifics of this process falls outside the boundaries of this blog post. Therefore, we won’t delve into that here.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In this blog post, we explored the world of hacking Cocos2D Android games using Frida. We emphasized responsible and ethical use of the techniques and tools discussed. We covered static analysis, examining source code, and dynamic analysis for inspecting games while running. We discussed the extraction of images from asset files using the <code>ActionGroupClass</code>. Remember, unauthorized hacking is illegal and unethical. Use this knowledge responsibly to enhance your understanding of software and promote improved security. Happy exploring!</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-08-31T07:24:00.000Z" title="8/31/2023, 3:24:00 PM">2023-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-07T08:39:54.134Z" title="1/7/2024, 4:39:54 PM">2024-01-07</time></span><span class="level-item">10 minutes read (About 1474 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/31/Hacking-Android-game-using-Frida-Part3/">Hacking Android Game using Frida - Part3</a></p><div class="content"><h1 id="Hacking-Android-Game-with-Frida-Part3"><a href="#Hacking-Android-Game-with-Frida-Part3" class="headerlink" title="Hacking Android Game with Frida (Part3)"></a>Hacking Android Game with Frida (Part3)</h1><p>In the previous blog <a href="http://mengxipeng1122.github.io/2023/08/29/Hacking-Android-game-using-Frida-Part2/">post</a>, we discussed how to create a NDK project to interact with an Android game. In this follow-up article, we will delve deeper into the game’s internals by call fucntions in <code>libmain.so</code>.</p>
<h2 id="Analyzing-libmain-so"><a href="#Analyzing-libmain-so" class="headerlink" title="Analyzing libmain.so"></a>Analyzing <code>libmain.so</code></h2><p>We have chosen a game for analysis because its libmain.so contains a multitude of interesting functions. To examine the symbols exported by the library, execute the following command:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -sW libmain.so</span><br></pre></td></tr></table></figure>
<p>In our case, the library exports over 36,000 symbols. In theory, we can call each exported symbol using C++. This presents an exciting opportunity for exploration.</p>
<h2 id="Conducting-Static-and-Dynamic-Analysis-of-libmain-so"><a href="#Conducting-Static-and-Dynamic-Analysis-of-libmain-so" class="headerlink" title="Conducting Static and Dynamic Analysis of libmain.so"></a>Conducting Static and Dynamic Analysis of <code>libmain.so</code></h2><p>Before calling these functions from C++, it is essential to establish a goal. In our current scenario, our goal is relatively simple: we want to list all assets in the game, including their names and types. To accomplish this, we need to extract relevant class definitions from <code>libmain.so</code>. For static analysis, we will employ Ghidra, while Frida will assist us in adding hooks to key functions for inspecting the game’s internal state and memory data. Please note that this process is complex and time-consuming, but the results are well worth the effort. While we won’t delve into the entire analysis process in this blog, we will share the final results. The following are the classes we extracted for listing all assets in the game:</p>
<p>Note: These class definitions are highly dependent on the version of libmain.so used. The MD5 hash of the libmain.so file we worked with is <code>e721395e3e327899a5a55ea4fb422a1c</code>. Additionally, to ensure compatibility with a C compiler and facilitate analysis in Ghidra, I have utilized __cplusplus macros in the code. Ghidra supports C code, and by using these macros, we can import the code into Ghidra for easier analysis. This allows us to leverage Ghidra’s capabilities while working with the codebase.</p>
<h3 id="VuAsset"><a href="#VuAsset" class="headerlink" title="VuAsset"></a>VuAsset</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VuAsset</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VuAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * _vtab;               <span class="comment">// 0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    std::string _name;          <span class="comment">// 0x08</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _name[<span class="number">0x18</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The <code>VuAsset</code> class has a member variable, <code>_name</code>, of type std::string at offset 0x08, used to store the names of assets. In the ARM64 platform, a pointer occupies 8 bytes.</p>
<h3 id="VuAssetDB"><a href="#VuAssetDB" class="headerlink" title="VuAssetDB"></a>VuAssetDB</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VuAssetDB  size 0xe0</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VuAssetDB</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _0x0[<span class="number">0x40</span> ];   <span class="comment">// 0x00</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    std::map&lt;std::string, std::vector&lt;std::string&gt;&gt; _assetNames;  <span class="comment">// 0x40</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _assets[<span class="number">0x18</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The <code>VuAssetDB class</code> contains a member variable of type <code>std::map&lt;std::string, std::vector&lt;std::string&gt;&gt;</code> at offset 0x40, used to store the names of assets. The key of this variable is of type <code>std::string</code>, storing asset type names, while the value is of type <code>std::vector&lt;std::string&gt;</code>, storing asset names of the same type. We will utilize this class to print all asset names and types in the game.</p>
<h3 id="VuAssetFactory"><a href="#VuAssetFactory" class="headerlink" title="VuAssetFactory"></a>VuAssetFactory</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VuAssetFactory size 0x190</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VuAssetFactory</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _0x0[<span class="number">0x38</span> ]; <span class="comment">// 0x00</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    std::vector&lt;std::string&gt; _assetTypeNames; <span class="comment">// 0x38</span></span><br><span class="line">    std::map&lt;std::string, <span class="type">void</span>*&gt; _assetTypeInfos; <span class="comment">// 0x50</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _asssetTypeNames[<span class="number">0x18</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _asssetTypeInfos[<span class="number">0x18</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    VuAssetDB* _vuAssetDB; <span class="comment">// 0x68</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _0x70[<span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    std::unordered_map&lt;<span class="type">unsigned</span> <span class="type">int</span>, VuAsset*&gt; _loadedAssets; <span class="comment">// 0x78</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _asssetTypeNames[<span class="number">0x28</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    <span class="type">static</span> VuAssetFactory* mpInterface;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<p>The <code>VuAssetFactory</code> class includes a member variable of type <code>std::vector&lt;std::string&gt;</code> at offset 0x38, used to store asset type names. We can utilize this member variable to print all asset type names. Additionally, this class has a member variable of type <code>VuAssetDB*</code> at offset 0x68 to store the pointer to VuAssetDB. Furthermore, it contains a member variable of type <code>std::unordered_map&lt;unsigned int, VuAsset*&gt;</code> at offset 0x78, used to store loaded assets. The key of this variable is of type unsigned int, representing the asset hash calculated by asset name, and the valueis of type <code>VuAsset*</code>, storing the asset pointer. Lastly, the class includes a static member variable of type <code>VuAssetFactory*</code> to store the global instance of VuAssetFactory. This class follows the singleton design pattern, allowing us to obtain the global VuAssetFactory instance using mpInterface.</p>
<h2 id="Helper-Function-for-Obtaining-the-Actual-Class-Name-of-VuAsset-Children"><a href="#Helper-Function-for-Obtaining-the-Actual-Class-Name-of-VuAsset-Children" class="headerlink" title="Helper Function for Obtaining the Actual Class Name of VuAsset Children"></a>Helper Function for Obtaining the Actual Class Name of VuAsset Children</h2><p>Based on our analysis, we have observed that <code>VuAsset</code> acts as a base class for other asset-related classes. To simplify our tasks, we have implemented a helper function that allows us to retrieve the actual class names. Please find the code snippet below:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">const</span> std::type_info&amp; <span class="title">getTypeInfoOfInstance_ndk</span><span class="params">(<span class="type">void</span>* p)</span>               </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    p = *(<span class="type">void</span>**)p;                                                           </span><br><span class="line">    p = ((<span class="type">void</span>**)p)[<span class="number">-1</span>];                                                                                                                                     </span><br><span class="line">    <span class="keyword">return</span> *(std::type_info*)p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Given that <code>libgame.so</code> is compiled with the RTTI (Run-Time Type Information) option, we can utilize the <code>getTypeInfoOfInstance_ndk</code> function to obtain the class information of instances. It’s important to note that we cannot directly use the typeid operator to retrieve runtime type information (RTTI) of an object. This is because <code>libgame.so</code> contains the RTTI information, and when we write our C++ code in <code>libmousebot.so</code>, the typeid operator will provide the RTTI information from <code>libmousebot.so</code>, which may lead to incorrect results. Since we don’t have visibility into how the derived classes of <code>VuAsset</code> are defined, the <code>getTypeInfoOfInstance_ndk</code> function helps us retrieve the accurate class information from <code>libgame.so</code>.</p>
<h2 id="Print-all-assets-names-and-types"><a href="#Print-all-assets-names-and-types" class="headerlink" title="Print all assets names and types"></a>Print all assets names and types</h2><p>Now, it’s time to rock! In this section, we will demonstrate how to print all asset names and types using functions provided by libgame.so. This will serve as a great starting point for exploring Frida’s capabilities and the powerful combination of Frida and C++.</p>
<ol>
<li><p>Get global pointer to the instance of <code>VuAssetFactory</code><br>To begin, we need to obtain the global pointer to the instance of <code>VuAssetFactory</code>. This can be achieved with the following code snippet:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* pVuAssetFactory = VuAssetFactory::mpInterface; </span><br></pre></td></tr></table></figure></li>
<li><p>Get the instance of <code>VuAssetDB</code><br>Next, we retrieve the instance of <code>VuAssetDB</code> using the pointer obtained in the previous step. The code is as follows:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* pVuAssetDB = pVuAssetFactory-&gt;_vuAssetDB;</span><br></pre></td></tr></table></figure></li>
<li><p>List all assets in <code>VuAssetDB</code><br>In this step, we iterate through all the assets in <code>VuAssetDB</code> and print their names and types. The code snippet below demonstrates this process:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">for</span>( <span class="keyword">auto</span> it = pVuAssetDB-&gt;_assetNames.<span class="built_in">begin</span>(); it != pVuAssetDB-&gt;_assetNames.<span class="built_in">end</span>(); ++it)&#123;                                                              </span><br><span class="line">    <span class="keyword">auto</span>&amp; assetType = it-&gt;first;</span><br><span class="line">    <span class="keyword">auto</span>&amp; names = it-&gt;second;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it1=names.<span class="built_in">begin</span>(); it1!=names.<span class="built_in">end</span>(); ++it1)&#123;</span><br><span class="line">        <span class="built_in">LOG_INFOS</span>(<span class="string">&quot; %s : %s&quot;</span>, assetType.<span class="built_in">c_str</span>(), it1-&gt;<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here, the <code>LOG_INFOS</code> macro is used to print the asset information, which internally calls the <code>_frida_log</code> function.<br>The resulting output will be similar to the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;...&gt;</span><br><span class="line">[/mnt/work/work.2023/frida-hackinggame/jni/mousebot.cc:104]  VuTextureAsset : UI/Icons/Inventory_Prize                                                       </span><br><span class="line">[/mnt/work/work.2023/frida-hackinggame/jni/mousebot.cc:104]  VuTextureAsset : UI/Icons/Inventory_Skin                                                        </span><br><span class="line">[/mnt/work/work.2023/frida-hackinggame/jni/mousebot.cc:104]  VuTextureAsset : UI/Icons/KeyCard_A    </span><br><span class="line">&lt;...&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>List All Loaded Assets in the Game<br>In this final step, we will list all the loaded assets in the game. Although <code>VuAssetDB</code> contains all the assets, it only provides basic information for each asset. During the game runtime, the actual asset data is loaded on demand.<br>The code snippet below demonstrates how to iterate through the loaded assets and print their information:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>&amp; v = pVuAssetFactory-&gt;_loadedAssets;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> it = v.<span class="built_in">begin</span>(); it != v.<span class="built_in">end</span>(); ++it)&#123;</span><br><span class="line">    <span class="keyword">auto</span>* pAsset = it-&gt;second;</span><br><span class="line">    <span class="keyword">auto</span>&amp; k = it-&gt;first;</span><br><span class="line">    <span class="keyword">auto</span>&amp; assetTypeInfo = <span class="built_in">getTypeInfoOfInstance_ndk</span>(pAsset);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* assetTypeName = assetTypeInfo.<span class="built_in">name</span>();</span><br><span class="line">    <span class="built_in">LOG_INFOS</span>(<span class="string">&quot; %x pAsset %p assetTypeName %s assetName %s&quot;</span>, k, pAsset, assetTypeName, pAsset-&gt;_name.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this code, we use the <code>getTypeInfoOfInstance_ndk</code> function to retrieve the actual class name of each asset instance. The resulting output will be similar to the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;...&gt;</span><br><span class="line">[/mnt/work/work.2023/frida-hackinggame/jni/mousebot.cc:118]  e1fc0284 pAsset 0x77e86e1e40 assetTypeName 18VuStaticModelAsset assetName Env/Hall/Straight_16m</span><br><span class="line">[/mnt/work/work.2023/frida-hackinggame/jni/mousebot.cc:118]  93b383af pAsset 0x77c03b1f00 assetTypeName 15VuMaterialAsset assetName Paper/Cardboard_Wall</span><br><span class="line">[/mnt/work/work.2023/frida-hackinggame/jni/mousebot.cc:118]  9f8e3cbb pAsset 0x77b8be9810 assetTypeName 15VuTemplateAsset assetName Tile_Hall_Hazard/Hall_Hazard_Stomper_2x_16m</span><br><span class="line">&lt;...&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>You can find the complete source code in the <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/frida-hackinggame">repository</a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Congratulations! This marks the end of our exploration series. In this final log, we have successfully printed all asset information in the game using the functions provided by <code>libgame.so</code>. This serves as a solid foundation for further exploration of Frida’s capabilities. The combination of Frida and C++ opens up a world of possibilities, allowing us toperform various interesting tasks. With the knowledge gained from this series, you can continue your journey of hacking and exploring the game.</p>
<p>Remember, Frida and C++ together are a powerful toolset that can enable us to accomplish a wide range of tasks. The ability to access and manipulate game assets opens up exciting possibilities for customization, analysis, and experimentation.</p>
<p>Happy hacking, and enjoy your adventures in the world of game exploration!</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-08-29T06:53:23.000Z" title="8/29/2023, 2:53:23 PM">2023-08-29</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">9 minutes read (About 1350 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/29/Hacking-Android-game-using-Frida-Part2/">Hacking Android game using Frida - Part2</a></p><div class="content"><h1 id="Hacking-Android-Games-with-Frida-Part2"><a href="#Hacking-Android-Games-with-Frida-Part2" class="headerlink" title="Hacking Android Games with Frida (Part2)"></a>Hacking Android Games with Frida (Part2)</h1><p>In the previous blog <a href="http://mengxipeng1122.github.io/2023/08/29/Hacking-Android-game-using-Frida-Part1/">post</a>, we discussed how to create a Frida Typescript project to interact with an Android game. In this follow-up article, we will delve deeper into the game’s internals by using the NDK (Native Development Kit) and explore the process of hacking Android games using Frida.</p>
<h2 id="NDK-Version-enumeration"><a href="#NDK-Version-enumeration" class="headerlink" title="NDK Version enumeration"></a>NDK Version enumeration</h2><p>To begin, we need to identify the NDK version used to compile the game’s native library (libmain.so). Follow these steps:<br>    1. Navigate to the game data directory on the Android device. The path may vary, but an example path is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/app/com.vectorunit.mercury.googleplay-hN_B8AKQmUeVXiBbDZ2Vvg==/lib/arm64</span><br></pre></td></tr></table></figure>
<p>Note: Replace com.vectorunit.mercury.googleplay-hN_B8AKQmUeVXiBbDZ2Vvg&#x3D;&#x3D; with the actual game ID on your device.<br>    2. In the game data directory, we can find a file <code>libmain.so</code>. Copy it to PC.<br>    3. Extract strings from libmain.so using the following command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings -tx libmain.so</span><br></pre></td></tr></table></figure>
<p>Look for the version strings and commit IDs in the command output. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ad4dac Android (7714059, based on r416183c1) clang version 12.0.8 (https://android.googlesource.com/toolchain/llvm-project c935d99d7cf2016289302412d708641d52d2f7ee)</span><br><span class="line">ad4e4a Android (4691093 based on r316199) clang version 6.0.2 (https://android.googlesource.com/toolchain/clang 183abd29fc496f55536e7d904e0abae47888fc7f) (https://android.googlesource.com/toolchain/llvm 34361f192e41ed6e4e8f9aca80a4ea7e9856f327) (based on LLVM 6.0.2svn)</span><br><span class="line">ad4f52 Linker: LLD 12.0.8 (/buildbot/src/android/llvm-r416183/out/llvm-project/lld c935d99d7cf2016289302412d708641d52d2f7ee)</span><br></pre></td></tr></table></figure>
<p>Perform a Google search using the version strings and commit IDs to determine the NDK version. In this example, I assume the game was compiled with NDK r17c.<br>    4. Download the according NDK from <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/downloads/index.html">here</a>, and uncompress it to your PC. </p>
<p>NOTE: NDK r17c is an older version and may not work with newer versions of Linux. Refer this <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48674104/clang-error-while-loading-shared-libraries-libtinfo-so-5-cannot-open-shared-o">page</a> for potential issues of to run clang++ on NDK r17c.  The provided solution in that post can help resolve the issue.</p>
<h1 id="Create-helper-function-in-Typescript-for-C-code"><a href="#Create-helper-function-in-Typescript-for-C-code" class="headerlink" title="Create helper function in Typescript for C++ code"></a>Create helper function in Typescript for C++ code</h1><p>Next, we will create two helper functions in Typescript that can be called from C++ code:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _frida_log = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">sp:NativePointer</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sp.<span class="title function_">readUtf8String</span>());                                         </span><br><span class="line">&#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">                                       </span><br><span class="line"><span class="keyword">const</span> _frida_hexdump = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">sp:NativePointer, sz:<span class="built_in">number</span></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(                                                              </span><br><span class="line">        <span class="title function_">hexdump</span>(sp, &#123;</span><br><span class="line">            <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">length</span>: sz,</span><br><span class="line">            <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">ansi</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;uint&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<ul>
<li>_frida_log: This function outputs a string and accepts a pointer to the string.</li>
<li>_frida_hexdump:This function performs a hexdump of a block of memory and accepts a pointer to the memory and its length.</li>
</ul>
<h1 id="Build-the-NDK-so-file"><a href="#Build-the-NDK-so-file" class="headerlink" title="Build the NDK .so file"></a>Build the NDK .so file</h1><p>To build the NDK shared library (.so file), follow these steps:</p>
<ol>
<li>Create a subdirectory named <code>jni</code>.</li>
<li>Navigate to the <code>jni</code> directory.</li>
<li>Create a C++ file named <code>mousebot.cc</code> with the following content:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="type">void</span> _frida_log(<span class="type">const</span> <span class="type">char</span>* p);</span><br><span class="line">    <span class="type">void</span> _frida_hexdump(<span class="type">void</span>* p, <span class="type">unsigned</span> <span class="type">int</span> i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">int</span> <span class="title">test</span><span class="params">(<span class="type">void</span>* base)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    _frida_log(<span class="string">&quot;Hello from C++ !&quot;</span>);</span><br><span class="line">    _frida_hexdump(base, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>The declarations for the helper functions are enclosed in extern “C” to avoid C++ name mangling.</li>
<li>The test function accepts a pointer to memory, calls the helper functions, and returns 0.</li>
</ul>
<ol start="4">
<li>Create <code>Android.mk</code> file with the following content:<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE:= mousebot</span><br><span class="line">LOCAL_SRC_FILES := mousebot.cc</span><br><span class="line">LOCAL_C_INCLUDES := </span><br><span class="line">LOCAL_LDLIBS :=</span><br><span class="line">LOCAL_CFLAGS= </span><br><span class="line">LOCAL_ALLOW_UNDEFINED_SYMBOLS := true</span><br><span class="line">LOCAL_SHARED_LIBRARIES =</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>This file instructs NDK to build a shared library. I set LOCAL_ALLOW_UNDEFINED_SYMBOLS to true to avoid compiler to complain about undefined symbols for our defined helper functions. We implements the helper functions in Typescript. We have no library for compiler to link.</li>
</ul>
<ol start="5">
<li>Create <code>Application.mk</code> file with the following content:<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APP_PLATFORM=android-27</span><br><span class="line">APP_ABI=arm64-v8a</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>To determine the Android API level of your device, use the following command:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop  | grep api_level</span><br></pre></td></tr></table></figure></li>
<li>To determine the CPU ABI, use the following command:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getporop ro.product.cpu.abi</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="6">
<li>Create <code>Makefile</code> file with the following content:<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifndef</span> NDKPATH</span><br><span class="line">    <span class="variable">$(<span class="built_in">error</span> NDKPATH not set)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="section">all: build_android</span></span><br><span class="line"></span><br><span class="line"><span class="section">build_android:</span></span><br><span class="line">        $&#123;NDKPATH&#125;/ndk-build V=1</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        $&#123;NDKPATH&#125;/ndk-build clean</span><br></pre></td></tr></table></figure>
This Makefile instructs the NDK to build the shared library, while enabling verbose mode with the V&#x3D;1 flag. Make sure to export the NDKPATH environment variable with the path to your actual NDK installation. By running <code>make</code>, the shared library will be built, and you can find it in the <code>libs/arm64-v8a/libmousebot.so</code> directory.</li>
</ol>
<h1 id="Convert-so-file-to-typescript-module"><a href="#Convert-so-file-to-typescript-module" class="headerlink" title="Convert .so file to typescript module"></a>Convert .so file to typescript module</h1><p>Next, we’ll convert the generated .so file into a TypeScript module. To accomplish this, we have provided a Python script called so2ts.py, which you can find <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/mengxipeng1122/frida-hackinggame/master/utils/so2ts.py">here</a>. The script performs the following steps:</p>
<ol>
<li>Parse the .so file using LIEF library</li>
<li>Generate a .ts file that loads the .so file manually:</li>
</ol>
<ul>
<li>Allocates memory for the .so file, and loads it into the allocated memory, set ting the permissions to <code>rwx</code>.</li>
<li>Applies hot patches to the .so file using the information from the relocation sectin.</li>
<li>Invokes constoructors of the .so file.</li>
</ul>
<p>To run the script, execute the following command:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./utils/so2ts.py -b libs/arm64-v8a/libmousebot.so -o modinfos/libmousebot.ts</span><br></pre></td></tr></table></figure>
<p>The generated TypeScript file will be located at <code>modinfos/libmousebot.ts</code>.</p>
<h1 id="Call-the-Test-function-in-Typescript"><a href="#Call-the-Test-function-in-Typescript" class="headerlink" title="Call the Test function in Typescript"></a>Call the Test function in Typescript</h1><p>Now that we have the converted TypeScript module, we can proceed to call the C++ function from TypeScript. Here’s how you can accomplish this:</p>
<h2 id="import-the-generated-ts-file"><a href="#import-the-generated-ts-file" class="headerlink" title="import the generated  .ts file"></a>import the generated  .ts file</h2><p>In your TypeScript code <code>index.ts</code>, import the generated .ts file as follows:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;mod <span class="keyword">as</span> libmousebotinfo&#125; <span class="keyword">from</span> <span class="string">&#x27;./modinfos/libmousebot&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="Load-the-so-file"><a href="#Load-the-so-file" class="headerlink" title="Load the .so file"></a>Load the .so file</h2><p>Add the following code to index.ts to load the .so file:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> soname =<span class="string">&#x27;libmain.so&#x27;</span></span><br><span class="line"><span class="keyword">const</span> lib = libmousebotinfo.<span class="title function_">load</span>([</span><br><span class="line">    soname,</span><br><span class="line">],&#123;</span><br><span class="line">    _frida_log      , </span><br><span class="line">    _frida_hexdump  ,</span><br><span class="line">     </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>In the code snippet above, <code>soname</code> represents the name of the original <code>libmain.so</code> file. Since the game process loads this .so file during boot, we pass <code>soname</code> to libmousebotinfo.load to enable our .so file to resolve symbols from this library. Additionally, we pass <code>_frida_log</code> and <code>_frida_hexdump</code> to <code>libmousebotinfo.load</code> to provide these two functions to our .so file.</p>
<h2 id="Call-test-function"><a href="#Call-test-function" class="headerlink" title="Call test function"></a>Call test function</h2><p>To call the test function in libmousebot.so, use the following TypeScript code:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> m = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(soname);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">NativeFunction</span>(lib.<span class="property">symbols</span>.<span class="property">test</span>, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])(m.<span class="property">base</span>);</span><br></pre></td></tr></table></figure>
<p>In the code snippet above, we obtain the base address of <code>libmain.so</code> using <code>Process.getModuleByName</code>. Then, we invoke the test function in <code>libmousebot.so</code>  using <code>lib.symbols.test</code>, where <code>lib.symbols</code> includes all the symbols exported by <code>libmousebot.so</code>.</p>
<h2 id="Recompile-index-ts-and-inject-the-Frida-script"><a href="#Recompile-index-ts-and-inject-the-Frida-script" class="headerlink" title="Recompile index.ts and inject the Frida script"></a>Recompile <code>index.ts</code> and inject the Frida script</h2><p>With all the necessary code prepared, we can recompile index.ts and inject the Frida script into the game process. Use the following command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l _agent.js -n &#x27;MouseBot&#x27;</span><br></pre></td></tr></table></figure>
<p>When executed, the console will display the following output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">##################################################</span><br><span class="line">Hello from C++ !</span><br><span class="line">             0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">7a26ace000  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00  .ELF............</span><br><span class="line">7a26ace010  03 00 b7 00 01 00 00 00 d4 04 72 00 00 00 00 00  ..........r.....</span><br></pre></td></tr></table></figure>

<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>In this tutorial, we have learned how to build a shared library using the Android NDK and call C++ functions from TypeScript. By leveraging Frida, we successfully integrated the functionalities of <code>libmousebot.so</code> with the existing <code>libmain.so</code> of the game process. This opens up possibilities for further exploration and utilization of Frida’s capabilities.</p>
<p>In the next blog post, we will delve deeper into Frida’s extensive feature set and explore how to call functions in <code>libmain.so</code> from our custom <code>libmousebot.so</code>.</p>
<p>Thank you for following along! If you have any further questions or need assistance, feel free to reach out.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-08-29T03:26:43.000Z" title="8/29/2023, 11:26:43 AM">2023-08-29</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">4 minutes read (About 659 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/29/Hacking-Android-game-using-Frida-Part1/">Hacking Android game using Frida - Part1</a></p><div class="content"><h1 id="Hacking-Android-Games-with-Frida-Part1"><a href="#Hacking-Android-Games-with-Frida-Part1" class="headerlink" title="Hacking Android Games with Frida (Part1)"></a>Hacking Android Games with Frida (Part1)</h1><h2 id="Disclaimer"><a href="#Disclaimer" class="headerlink" title="Disclaimer:"></a>Disclaimer:</h2><p>The techniques and information presented in this serial of blogs are strictly for educational purposes. Unauthorized use of these techniques for illicit activities, including game hacking, is strictly prohibited. The author and publisher do not condone or support any form of illegal or unethical behavior. It is essential to respect the intellectual property rights of game developers and adhere to the terms of service. Any actions taken based on the knowledge gained from this blog are solely at the reader’s own risk, and the author and publisher are not liable for any misuse or legal consequences that may arise.</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction:"></a>Introduction:</h2><p>Mobile gaming has become a massive industry, and many players strive to gain an edge by tweaking or modifying Android games. One powerful tool for game hacking is <a target="_blank" rel="noopener" href="https://frida.re/">Frida</a>, an open-source dynamic instrumentation framework. In this serial of blogs, we will guide you through the process of creating a Frida project using TypeScript, enabling you to hack Android games and unlock new possibilities.<br>I will put all source codes in <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/frida-hackinggame">here</a>.</p>
<h2 id="The-Game-for-Testing"><a href="#The-Game-for-Testing" class="headerlink" title="The Game for Testing:"></a>The Game for Testing:</h2><p>For the purpose of testing and learning, we will use “MouseBot”, a popular and addictive runner game developed by Vector Unit. You can download the Android version of the game for free from the Play Store <a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.vectorunit.mercury.googleplay&hl=en&gl=US">here</a>. It’s free.</p>
<h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites:"></a>Prerequisites:</h1><p>To follow along with this tutorial, you’ll need the following:</p>
<ul>
<li>A basic understanding of TypeScript.</li>
<li>Node.js installed on your machine.</li>
<li>A rooed Android device or emulator.</li>
<li>Frida installed on your machine.</li>
<li>Test game , MouseBot, installed in your machine.</li>
</ul>
<h1 id="Step-1-Setting-Up-the-Project"><a href="#Step-1-Setting-Up-the-Project" class="headerlink" title="Step 1: Setting Up the Project"></a>Step 1: Setting Up the Project</h1><ul>
<li>Create a new directory for your Frida project.</li>
<li>Open a terminal or command prompt and navigate to the project directory.</li>
<li>Create a file named <code>package.json</code> in the project directory. You can view its content from <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/mengxipeng1122/frida-hackinggame/master/package.json">here</a>.</li>
<li>Create a file named <code>tsconfig.json</code> in the project directory. You can view its content from <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/mengxipeng1122/frida-hackinggame/master/tsconfig.json">here</a>.</li>
<li>Install the Frida library for TypeScript and frida-compile by executing the following command, I have write these libraries in this <code>package.json</code>:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i </span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Step-2-Writing-the-Frida-Script"><a href="#Step-2-Writing-the-Frida-Script" class="headerlink" title="Step 2: Writing the Frida Script"></a>Step 2: Writing the Frida Script</h1><ul>
<li>Inside your project directory, create a new TypeScript file, index.ts:</li>
<li>Open the file in your preferred code editor.<br>Write the Frida script to print <code>Hello world</code> to the console.<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">test</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;##################################################&#x27;</span>)</span><br><span class="line"><span class="title function_">test</span>()</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Step-3-Running-the-Frida-Script"><a href="#Step-3-Running-the-Frida-Script" class="headerlink" title="Step 3: Running the Frida Script"></a>Step 3: Running the Frida Script</h1><ul>
<li>Save the game-hack.ts file.</li>
<li>Open a terminal or command prompt and navigate to the project directory.</li>
<li>Create a file named <code>Makefile</code> in the project directory. Its content is shown as follows:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">all:</span><br><span class="line">        ./node_modules/frida-compile/bin/compile.js -o _agent.js index.ts</span><br></pre></td></tr></table></figure></li>
<li>Compile the TypeScript file into JavaScript using the following command:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
This command will create a file named _agent.js in the project directory.</li>
<li>Run the Frida script using the following command:</li>
<li>Setup your Android device, start frida-server. <a target="_blank" rel="noopener" href="https://frida.re/docs/android/">This page</a> has detailed instructions for this step.</li>
<li>Launch <code>MouseBot</code> on your Android device or emulator.</li>
<li>Execute the following command to inject the Frida script into the game process:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l _agent.js -n &#x27;MouseBot&#x27;</span><br></pre></td></tr></table></figure>
If everything goes well, Frida will inject the script into the game process. and you will see <code>Hello world</code> in the console.</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion:"></a>Conclusion:</h1><p>In this blog, we explored the initial steps of creating a Frida project using TypeScript and injecting a basic Frida script into an Android game. We emphasized the importance of using this knowledge responsibly and for educational purposes only. In the next blog of this series, we will delve deeper into Frida’s capabilities and explore more advanced game hacking techniques. Stay tuned and happy hacking!</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-25T01:14:27.000Z" title="7/25/2022, 9:14:27 AM">2022-07-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">4 minutes read (About 625 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/25/An-inlinehook-library-using-Frida/">An inlinehook library using Frida</a></p><div class="content"><p>This article introduces an inline hook library using Frida, and you can download all codes about this at this <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/frida-android-inlinehook.git">link</a>. And I only implement it on ARM64 architecture.</p>
<h1 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h1><p>In my opinion, <code>inlinehook</code> just like put a breakpoint in debugger. Users can hook at any instructions, and executes any codes once the hook is triggered.</p>
<h1 id="How-to-implement-it"><a href="#How-to-implement-it" class="headerlink" title="How to implement it"></a>How to implement it</h1><h2 id="Basic-steps"><a href="#Basic-steps" class="headerlink" title="Basic steps"></a>Basic steps</h2><ul>
<li>Put a jump code at the hook point, to jump to our trampoline code. </li>
<li>Trampoline code does the following:<ul>
<li>Save current registers.</li>
<li>Invoke hook handler function.</li>
<li>Restore all registers.</li>
<li>Execute instructions at hook point.</li>
<li>Jump back to next instruction after the hook point.</li>
</ul>
</li>
</ul>
<h2 id="Implementation-using-Frda"><a href="#Implementation-using-Frda" class="headerlink" title="Implementation using Frda"></a>Implementation using Frda</h2><h3 id="How-to-add-hook"><a href="#How-to-add-hook" class="headerlink" title="How to add hook"></a>How to add hook</h3><p>Before add inline hook, user should prepare the following things:</p>
<ul>
<li>Hook point<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hook_ptr = <span class="language-xml"><span class="tag">&lt;<span class="name">Address</span> <span class="attr">of</span> <span class="attr">the</span> <span class="attr">instruction</span> <span class="attr">will</span> <span class="attr">be</span> <span class="attr">hooked</span>&gt;</span> ;</span></span><br></pre></td></tr></table></figure>
We can add hooks at any instruction.</li>
<li>Hook handle function<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> frida_fun = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">para1:NativePointer, sp:NativePointer</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;para1&#x27;</span>, para1, <span class="string">&#x27;sp&#x27;</span>, sp);</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
This function has two arguments, all are of type NativePointer. The first argument is named <code>para1</code>, and we can assign it when we add hook, the second argument is named <code>sp</code>, of value in the <code>sp</code> register, we can access values in the stack by this argument.</li>
<li>Memory for trampoline code<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> trampoline_ptr = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(trampoline_len)</span><br></pre></td></tr></table></figure>
We can allocate a new memory for trampoline code. And because allocated memory is usually far from the hook point, so we have to use a long jump instruction at the hook point. Long jump instruction usually occupies more bytes. For using near jump instruction, we can try to find a cave near the hook point, and use the found cave to store trampoline code.<blockquote>
<p>Warning: when we allocate memory, do not use a local variable for the returned pointer, use a global variable instead. Javascript’s garbage collection mechanism will free this memory automatically once the program is out of the local variable’s scope, and will crash the process. </p>
</blockquote>
</li>
<li>Parameter1 pass to hook handle function <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> para1 = <span class="language-xml"><span class="tag">&lt;<span class="name">parameter1</span> <span class="attr">pass</span> <span class="attr">to</span> <span class="attr">hook</span> <span class="attr">handle</span> <span class="attr">function</span>&gt;</span>;</span></span><br></pre></td></tr></table></figure>
We can pass a parameter to the hook handle function, and this parameter is of type NativePointer</li>
</ul>
<p>Now invoke <code>InlineHooker.inlineHookPatch</code> to add a inline hook, just as follows</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sz = <span class="title class_">InlineHooker</span>.<span class="title function_">inlineHookPatch</span>(trampoline_ptr,hook_ptr, hook_fun_ptr, para1);</span><br></pre></td></tr></table></figure>
<p>This function return a number, indicating the length of the trampoline code. </p>
<h3 id="Code-relocation"><a href="#Code-relocation" class="headerlink" title="Code relocation"></a>Code relocation</h3><p>For inline hook, we need to move some instructions from one address to another. And we need to rewrite some instructions, just like B&#x2F;BL instruction in ARM64 architecture.<br>I am using the code in this <a target="_blank" rel="noopener" href="https://github.com/bytedance/android-inline-hook.git">link</a> for rewriting instructions. I port the C code in this <a target="_blank" rel="noopener" href="https://github.com/bytedance/android-inline-hook/blob/main/shadowhook/src/main/cpp/arch/arm64/sh_a64.c">file</a> to Typescript code. <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/frida-android-inlinehook/blob/master/src/sh_a64.ts">This file</a> is my ported code. ARM64 instruction set is relatively easy, and Thumb&#x2F;Arm32 is too complex, we may port its code in the future.<br>This file exports this method to rewrite code</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span>  sh_a64_rewrite=(<span class="attr">buf</span>:<span class="title class_">NativePointer</span>, <span class="attr">inst</span>:<span class="built_in">number</span>, <span class="attr">pc</span>:<span class="title class_">NativePointer</span> ):<span class="function"><span class="params">number</span>=&gt;</span></span><br></pre></td></tr></table></figure>
<p>This method has 3 arguments</p>
<ul>
<li>buf, the target address of current instruction </li>
<li>inst, current instruction</li>
<li>pc, the source address of current instruction<br>This method also return a variable of type number, to indicate how many instructions has written to target address.  We actually need to rewrite several instructions for one B instruction to avoid change its behavior.</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I wrote an inline hook library using Frida. Inline Hooking is not very easy, specially in some architecture, I only implemented on ARM64, and will do more work on other architecture.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-29T01:41:19.000Z" title="6/29/2022, 9:41:19 AM">2022-06-29</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">10 minutes read (About 1437 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/29/Inline-hook-with-Frida-Thumb-version/">Inline hook with Frida (Thumb version)</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#interceptor">Interceptor.attach</a> in Frida only can hook one function. So the first argument, <code>target</code>, should be a function address. In my opinion, <code>inline hook</code> just let users can hook arbitrary instruction at any address. In this article, I will try to introduce a method to implement inline hook using Frida. and only implement for Thumb binary so far.</p>
<h1 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h1><p>To implement inline hook, we need to do the following thing:</p>
<ul>
<li>Save original bytes at hook target</li>
<li>Write a hook handle function in .so file in C&#x2F;C++.</li>
<li>Write a trampoline code in Thumb. And put original bytes into trampoline code.</li>
<li>Put a BL instruction at hook target.</li>
</ul>
<p>I will describe every stage in detail, and for convenience, I will user the following terminology:</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>hook_ptr</code></td>
<td>The address of hook target, same as the <code>target</code> argument in <code>Interceptor.attach</code></td>
</tr>
<tr>
<td><code>hook_fun_ptr</code></td>
<td>The address of hook handle function, we define this function in .so file</td>
</tr>
<tr>
<td><code>tempoline_ptr</code></td>
<td>The address of trampoline code</td>
</tr>
</tbody></table>
<p>So if we set every code correctly, once CPU reaches <code>hook_ptr</code>, CPU will call trampoline code as a function. And the trampoline code will call hook handle function and execute the original instruction copy from <code>hook_ptr</code>. And we can do anything we want in hook handle function.</p>
<h2 id="Save-original-bytes-at-hook-ptr"><a href="#Save-original-bytes-at-hook-ptr" class="headerlink" title="Save original bytes at hook_ptr"></a>Save original bytes at <code>hook_ptr</code></h2><p>We will put a BL instruction at this address, so we need to save original bytes at first. In Thumb,  a BL instruction occupies 4 bytes. So we need to save at least 4 bytes. It may include 1-2 Thumb instructions at <code>hook_ptr</code>, and we must be careful in selection of a <code>hook_ptr</code>.</p>
<ul>
<li>Avoid odd <code>hook_ptr</code></li>
<li>Do not select a <code>hook_ptr</code> at a middle of a Thumb instruction</li>
<li>Do not select a <code>hook_ptr</code> at a 2 bytes Thumb instruction followed by a 4 bytes Thumb instruction</li>
</ul>
<p>I dissembled libMyGame.so with the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-objdump -S /tmp/libMyGame.so | <span class="built_in">tee</span> /tmp/libMyGame.s</span><br></pre></td></tr></table></figure>
<p>And, there are 2 files named <code>libMyGame.so</code> in this game. We should use <code>libMyGame.so</code> file in the path <code>lib/armeabi-v7a</code>. Because this file is according to Thumb version. I selected <code>hook_ptr</code> at <code>0x267782</code>: </p>
<blockquote>
<p> 26777e:	9a03      	ldr	r2, [sp, #12]<br> 267780:	6823      	ldr	r3, [r4, #0]<br> 267782:	4630      	mov	r0, r6   @ here, our <code>hook_ptr</code><br> 267784:	429a      	cmp	r2, r3<br> 267786:	d001      	beq.n	26778c &lt;_ZN7cocos2d11Application10getVersionEv@@Base+0x3c&gt;</p>
</blockquote>
<p>This <code>hook_ptr</code> is in the function <code>cocos2d::Application::getVersion</code>. So when call this <code>getVersion</code> function, just like we did in <a href="2022/06/28/A-new-method-to-write-CModule-in-Frida-for-hacking-Android-applications/">previous post</a>, CPU should hit this <code>hook_ptr</code>.  Now, we saved  original bytes <code>30 46 9a 42</code>.<br>Note: <code>arm-linux-gnueabihf-objdump</code> displays instruction bytes from high address to low address. We also can use <code>hexdump</code> to show instruction byte, it’s in a clearer way. The command is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C -n 4 -s $((<span class="number">0</span>x267782)) /tmp/libMyGame.so</span><br></pre></td></tr></table></figure>
<p>The output should be as follows:</p>
<blockquote>
<p>00267782  30 46 9a 42                                       |0F.B|<br>00267786</p>
</blockquote>
<h2 id="Write-a-hook-handle-function"><a href="#Write-a-hook-handle-function" class="headerlink" title="Write a hook handle function."></a>Write a hook handle function.</h2><p>The prototype of the hook handle function is as follows, and it’s in the file, <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/main.cpp">main.cpp</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> <span class="title function_">hook_fun</span><span class="params">(<span class="type">void</span>* baseaddress, <span class="type">void</span>* sp)</span>;</span><br></pre></td></tr></table></figure>
<p>This function has 2 arguments. The 1st argument, <code>baseaddress</code>, is the base address of the <code>libMyGame.so</code>, and the 2nd argument, <code>sp</code>, is the value int register SP. Trampoline code will pass these 2 arguments to the hook handle function. <code>baseaddress</code> let us can access any data or function in <code>libMyGame.so</code> very easily. Trampoline code will store most CPU registers in the stack, so we can access these register values using <code>sp</code>.</p>
<h2 id="Write-trampoline-code"><a href="#Write-trampoline-code" class="headerlink" title="Write trampoline code"></a>Write trampoline code</h2><p>This code is in Thumb assembly. I list the code in here, and I put the offset of instructions at the beginning of every line.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">0x0:	push	&#123;r0, r1, r2, r3, r4, r5, r6, r7&#125;</span><br><span class="line">0x2:	push.w	&#123;r8, sb, sl, fp, ip, lr&#125;</span><br><span class="line">0x6:	mrs	r0, apsr</span><br><span class="line">0xa:	push	&#123;r0&#125;</span><br><span class="line">0xc:	nop</span><br><span class="line">0xe:	mov	r1, sp</span><br><span class="line">0x10:	ldr	r0, [pc, #0x14] @ --&gt; 0x28</span><br><span class="line">0x12:	ldr	r4, [pc, #0x18] @ --&gt; 0x2c</span><br><span class="line">0x14:	blx	r4</span><br><span class="line">0x16:	pop	&#123;r0&#125;</span><br><span class="line">0x18:	msr	cpsr_fc, r0</span><br><span class="line">0x1c:	pop.w	&#123;r8, sb, sl, fp, ip, lr&#125;</span><br><span class="line">0x20:	pop	&#123;r0, r1, r2, r3, r4, r5, r6, r7&#125;</span><br><span class="line">0x22:	nop</span><br><span class="line">0x24:	nop</span><br><span class="line">0x26:	bx	lr</span><br><span class="line">0x28:	nop</span><br><span class="line">0x2a:	nop</span><br><span class="line">0x2c:	nop</span><br><span class="line">0x2e:	nop</span><br></pre></td></tr></table></figure>
<p>0x0-0xa, save registers to stack, r0-r12, LR , and CPSR. We can learn more on ARM registers with <a target="_blank" rel="noopener" href="http://www.mathcs.emory.edu/~cheung/Courses/255/Syl-ARM/7-ARM/cpu1.html">this page</a>.<br>0xe, set the 2nd argument,<br>0x10, set the 1nd argument, we load the 1st argument from 0x28, and we will put the base address of <code>libMyGame.so</code> at 0x28 using Frida.<br>0x12, load the address of the hook handle function to R4, and we will put <code>hook_fun_ptr</code> at 0x2c using Frida.<br>0x14, call hook handle function<br>0x16-0x20, load registers from stack.<br>0x22-0x24, run original instructions at here. We will put saved original bytes at here using Frida.<br>0x26, return<br>0x28-0x2a, We store the base address of <code>libMyGame.so</code> at here.<br>0x2c-0x2e, We store the address of hook handle function at here.<br>Whole trampoline code occupies 0x30 bytes.</p>
<h3 id="About-selection-of-trampoline-ptr"><a href="#About-selection-of-trampoline-ptr" class="headerlink" title="About selection of trampoline_ptr"></a>About selection of <code>trampoline_ptr</code></h3><p>We can simple using <code>Memory.alloc</code> for trampoline code. Actually, we use near call instruction. This makes <code>trampoline_ptr</code> can not be too far from <code>hook_ptr</code>. We can find a cave to put our trampoline code in <code>libMyGame.so</code>. <a target="_blank" rel="noopener" href="https://www.hacking.land/2017/06/cave-miner-search-for-code-cave-in-all.html?m=1">CAVE MINER</a> is a great tool for this task. But I just do it manually for this sample case. I use the following command to list all segments in <code>libMyGame.so</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -l  /tmp/libMyGame.so</span><br></pre></td></tr></table></figure>
<p>The following is the output snippet:</p>
<blockquote>
<p>Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align<br>PHDR           0x000034 0x00000034 0x00000034 0x00120 0x00120 R   0x4<br>INTERP         0x000154 0x00000154 0x00000154 0x00013 0x00013 R   0x1<br>    [Requesting program interpreter: &#x2F;system&#x2F;bin&#x2F;linker]<br>LOAD           0x000000 0x00000000 0x00000000 0x691630 0x691630 R E 0x1000<br>LOAD           0x691f38 0x00692f38 0x00692f38 0x36b0c 0x42fac RW  0x1000<br>DYNAMIC        0x6bc6c8 0x006bd6c8 0x006bd6c8 0x00150 0x00150 RW  0x4</p>
</blockquote>
<p>The first load segment is end at 0x691630, and the second load segment is begin at 0x691f38. So cave at 0x691630 is perfect for our tempoline code.</p>
<h2 id="Put-a-BL-instruction-at-hook-target"><a href="#Put-a-BL-instruction-at-hook-target" class="headerlink" title="Put a BL instruction at hook target."></a>Put a BL instruction at hook target.</h2><p>We just use a near instruction to call trampoline code at <code>hook_ptr</code>, using <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#thumbwriter">thumbwriter</a> in Frida for this.</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>I wrote a method in <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/patchutils.ts">patchutils.js</a>, it’s defined as follows:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">putThumbHookPatch</span>(<span class="params">trampoline_ptr:NativePointer, hook_ptr:NativePointer, hook_fun_ptr:NativePointer, para1:NativePointer, origin_inst?:<span class="built_in">number</span>[]</span>):<span class="built_in">number</span></span><br></pre></td></tr></table></figure>
<ul>
<li>The 1st argument, <code>trampoline_ptr</code> is the address of trampoline code</li>
<li>The 2nd argument, <code>hook_ptr</code> is the address of hook target</li>
<li>The 3rd argument, <code>hook_fun_ptr</code> is the address of our hook handle function</li>
<li>The 4th argument, <code>para1</code> is the 1st parameter to our hook handle function, it will be assign to base address of <code>libMyGame.so</code> in caller</li>
<li>The 5th argument, <code>origin_inst</code> is the saved original bytes at <code>hook_ptr</code><br>And it returns the length of the trampoline code<br>I also wrote a test method in inlinehooktest.ts<a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/inlinehooktest.ts"></a>.</li>
</ul>
<h1 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h1><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following command to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_inlinehooktest</span><br></pre></td></tr></table></figure>
<p>And use the following command to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows.</p>
<blockquote>
<p>Hello World from so<br>cocos2d application version:<br>#################### Hook Begin ##############################<br>hook function from so<br>baseaddress 0xc8902000<br> CPSR  0x600e0010<br> R8    0x00000000<br> R9    0xbbdf8c18<br> R10   0xbbdf8b80<br> R11   0xbbdf8b90<br> R12   0xf3811ce8<br> LR    0xc8b69787<br> R0    0xbbdf8b70<br> R1    0x05c43127<br> R2    0x05c43127<br> R3    0x05c43127<br> R4    0xf3813260<br> R5    0xbbdf8b70<br> R6    0xdcc854b8<br> R7    0xbbdf8b88<br>#################### Hook end ##############################<br>1.8.12</p>
</blockquote>
<p>The hook handle function just do the following,</p>
<ul>
<li>print base address </li>
<li>dump values of all registers stored in the stack</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>This method still has many way to improve. And it only support Thumb. If you have any idea or issues, please feel free to let me know. I’m always glad to hack and discuss with others.<br>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a>.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-28T01:34:03.000Z" title="6/28/2022, 9:34:03 AM">2022-06-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">6 minutes read (About 966 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/28/A-new-method-to-write-CModule-in-Frida-for-hacking-Android-applications/">A new method to write CModule in Frida for hacking Android applications</a></p><div class="content"><h1 id="Why-a-new-method"><a href="#Why-a-new-method" class="headerlink" title="Why a new method"></a>Why a new method</h1><p>I introduced how to use official CModule in Frida at <a href="/2022/06/27/How-to-use-CMoudule-in-Frida/">last post</a>. But I think it have some weaknesses to improve. </p>
<ul>
<li>It can use C, this make us need to use ugly mangled function name when we want to call C++ functions</li>
<li>We need to embed C code in to Typescript code. So we can not find the error line quickly when C code does not pass compilation.</li>
</ul>
<h1 id="New-method"><a href="#New-method" class="headerlink" title="New method"></a>New method</h1><p>In here, I will introduce a new method to write a CModule in Frida. Please note, this method only work with Android platform, and I only tested on Arm32 archtecture. In theory, Arm64 archtecture should work either. This method has the following stage:</p>
<ul>
<li>Write a .so using Android NDK</li>
<li>Convert .so to a typescript module to hold all informations we needs when we want to load the .so</li>
<li>Load .so in Frida and call one function in it.<br>I tried to load .so using Module.load(), but this method always failed on Android platform. I think it because the restrictions of new versions Android, I used Android 10.</li>
</ul>
<h2 id="Write-a-so-using-Android-NDK"><a href="#Write-a-so-using-Android-NDK" class="headerlink" title="Write a .so using Android NDK"></a>Write a .so using Android NDK</h2><p>First, we write a .so in C++, the following is the code in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/main.cpp">main.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// declaration of functions in frida</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">frida_log_callback</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">frida_hexdump_callback</span><span class="params">(<span class="type">void</span>*, <span class="type">unsigned</span> <span class="type">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// declaration of functions in libMyGame.so</span></span><br><span class="line"><span class="keyword">namespace</span> cocos2d&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">        <span class="function"><span class="type">static</span> Application* <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function">std::string&amp;  <span class="title">getVersion</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">frida_log_callback</span>(<span class="string">&quot;Hello World from so&quot;</span>);</span><br><span class="line">    <span class="built_in">frida_log_callback</span>(<span class="string">&quot;cocos2d application version:&quot;</span>);</span><br><span class="line">    <span class="type">const</span> std::string&amp; version  = cocos2d::Application::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getVersion</span>();</span><br><span class="line">    <span class="built_in">frida_log_callback</span>(version.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Line 3-4, declares functions in Frida. And we need to add a options in our <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/Android.mk">Android.mk</a></p>
<blockquote>
<p>LOCAL_ALLOW_UNDEFINED_SYMBOLS :&#x3D; true</p>
</blockquote>
<p>Without this options, we can not pass the link because the compiler can not find these functions.<br>Line 8-13, declares functions in libMyGame.so. We can use C++ syntax here, and make our code more readable. And we need to declare entire C++ class in libMyGame.so, just declare the functions we want to call.<br>Line 16-23, defines a function for Typescript code to call. It just does the same thing as we did in <a href="/2022/06/27/How-to-use-CMoudule-in-Frida/">previous post</a>, print out cocos2d application version string.<br>And we need to set correct options in <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/jni/Application.mk">Application.mk</a>. </p>
<blockquote>
<p>APP_STL :&#x3D; gnustl_static<br>APP_ABI&#x3D;armeabi-v7a</p>
</blockquote>
<p>If these options is not compatible with libMyGame.so, our function will crush. Frankly, I tried all <code>APP_STL</code> variables, and finally find only <code>gnustl_static</code> is compatible with this game.</p>
<h2 id="Generate-a-Typescript-file-hold-all-information-when-loading"><a href="#Generate-a-Typescript-file-hold-all-information-when-loading" class="headerlink" title="Generate a Typescript file hold all information when loading"></a>Generate a Typescript file hold all information when loading</h2><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/pyscripts/so2tsmodule.py">python script</a>. This python scripts use <a target="_blank" rel="noopener" href="https://lief-project.github.io/">lief</a> to parse .so file to get the following informations.</p>
<ul>
<li>name, machine type </li>
<li>segments<br>  Only care about segments with load type, discard other segments</li>
<li>export symbols</li>
<li>relocations</li>
<li>ctors<br>  This is a list of functions, and we need to call these functions after loading.</li>
<li>dtors<br>  These functions should be called when unload the .so file, and I have not write code for it now.</li>
</ul>
<p>This script generates final Typescript file using <a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.9.x/intro/">jinja2</a>. The name of the template file is <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/pyscripts/so2tsmodule.jinja">so2tsmodule.jinja</a></p>
<h2 id="Load-so-file"><a href="#Load-so-file" class="headerlink" title="Load .so file"></a>Load .so file</h2><p>I wrote a method, named <code>loadSo</code>, in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/soutils.ts">soutils.ts</a>. Method prototype as follows</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">loadSo</span>(<span class="params">info:SoInfoType, syms?:&#123;[key:<span class="built_in">string</span>]:NativePointer&#125;, libs?:<span class="built_in">string</span>[]</span>):<span class="title class_">LoadSoInfoType</span></span><br></pre></td></tr></table></figure>
<ul>
<li>info is a object we defined in the Typescript file we generated in the last stage. </li>
<li>syms is a list of symbols we pass to the load modules</li>
<li>libs is a list of library names. This method try to find symbols in these libraries.</li>
</ul>
<p>We need to accomplish the following stages when load .so file:</p>
<ul>
<li>Allocate buffer, and set the permission to <code>rwx</code></li>
<li>Write all segments need to load to the buffer </li>
<li>Create a variable to hold all export symbols in the .so file</li>
<li>Handle relocations<br>  This stage is a little complicated. We need to find symbol addresses, and write correct number in the correct address accord to different recolcaion type.</li>
<li>Call ctors</li>
</ul>
<h2 id="Run-the-function-in-the-so-file"><a href="#Run-the-function-in-the-so-file" class="headerlink" title="Run the function in the .so file"></a>Run the function in the .so file</h2><p>The following is the Typescript code to do this. And it’s in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/sotest.ts">sotest.ts</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> soname =<span class="string">&quot;libMyGame.so&quot;</span></span><br><span class="line"><span class="keyword">let</span> m = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(soname)</span><br><span class="line"><span class="keyword">let</span> loadm = soutils.<span class="title function_">loadSo</span>(</span><br><span class="line">    mysoinfo.<span class="property">info</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        frida_log_callback : fridautils.<span class="property">frida_log_callback</span>,</span><br><span class="line">        frida_hexdump_callback : fridautils.<span class="property">frida_hexdump_callback</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    [</span><br><span class="line">        soname,</span><br><span class="line">    ]</span><br><span class="line">);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(loadm))</span><br><span class="line"></span><br><span class="line">fridautils.<span class="title function_">runFunWithExceptHandling</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(loadm.<span class="property">syms</span>.<span class="property">fun</span>,<span class="string">&#x27;void&#x27;</span>,[])</span><br><span class="line">    <span class="title function_">fun</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Line 3-12, loads the .so file.<br>We need to import generated Typescript file as a module using the following code </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> mysoinfo <span class="keyword">from</span> <span class="string">&#x27;./mysoinfo&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Line 6-7 lists all functions defined in Frida and will be called in C++ code<br>Line 10 lists all libraries contained the functions will be called in C++ code<br>Line 16-17 calls function <code>fun</code> in the C++ code.</p>
<h1 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h1><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following command to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_sotest</span><br></pre></td></tr></table></figure>
<p>And use the following command to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows</p>
<blockquote>
<p>Hello World from so<br>cocos2d application version:<br>1.8.12</p>
</blockquote>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a>.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-27T01:34:16.000Z" title="6/27/2022, 9:34:16 AM">2022-06-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">8 minutes read (About 1251 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/27/How-to-use-CMoudule-in-Frida/">How to use CModule in Frida</a></p><div class="content"><p>In this article, I will try to introduce how to use CModule in Frida.<br>My test Android APK is a small game, named “Knife hit”, you can download it from <a target="_blank" rel="noopener" href="https://apkpure.com/knife-hit/com.ketchapp.knifehit">APKpure website</a>. This is a Cocos2d game, it has a native library named ‘libMyGame.so’. This library file has many game logic codes. It exports many functions. We will try to call one of them to get Cocos2d application version and print out it. </p>
<h1 id="Why-typescript"><a href="#Why-typescript" class="headerlink" title="Why typescript?"></a>Why typescript?</h1><p>Later version of Frida support typescript. And Frida provides a <a target="_blank" rel="noopener" href="https://github.com/oleavr/frida-agent-example.git">demo</a> for starting of typescript coding. It use a NPM package, ‘<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/frida-compile">frida-compile</a>‘, for compiling of typescript code. Using typescript needs a compilation, it might take longer time to test the code, but we can avoid many issues in compilation. So I prefer typescript. </p>
<h1 id="What-is-a-CMoudule"><a href="#What-is-a-CMoudule" class="headerlink" title="What is a CMoudule"></a>What is a CMoudule</h1><p>This is its <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#cmodule">official documentation</a>. In my option, we can write some functions in C, and Frida provides a way to invoke these functions. The following is the example in the official documentation.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void hello(void) &#123;</span></span><br><span class="line"><span class="string">  printf(&quot;Hello World from CModule\\n&quot;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(cm));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(cm.<span class="property">hello</span>, <span class="string">&#x27;void&#x27;</span>, []);</span><br><span class="line"><span class="title function_">hello</span>();</span><br></pre></td></tr></table></figure>
<p>Line 1-7 create a CModule, it includes C code, and exports one function, ‘hello’ to print a welcome string.<br>Line 9 displays the information of the CModule. Frida is very smart, the C code should be compiled in here. And Frida should load the CModule in the memory space of the target process.<br>Line 11 convert function pointer to a NativeFunction for calling in Frida. So, cm.hello just is a NativePoiner.<br>Line 12 call hello function</p>
<h1 id="Write-our-own-CModule"><a href="#Write-our-own-CModule" class="headerlink" title="Write our own CModule"></a>Write our own CModule</h1><h2 id="Why-not-to-use-printf"><a href="#Why-not-to-use-printf" class="headerlink" title="Why not to use printf?"></a>Why not to use printf?</h2><p>Typescript code and C code is actually run in the target process’ memory space. And Android process usually do not use printf. They use <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/reference/group/logging#__android_log_print">__android_log_print</a> instead. But this function do not print message to Frida, we nee to run <code>adb logcat</code> to check its output. It’s not very convenience. We can write some functions in typescript to let C code to call.</p>
<h2 id="Typescript-functions-for-debugging"><a href="#Typescript-functions-for-debugging" class="headerlink" title="Typescript functions for debugging"></a>Typescript functions for debugging</h2><p>I wrote several helper functions in typescript, I put them in file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/fridautilts.ts">fridautils.ts</a>.</p>
<h3 id="frida-log-callback"><a href="#frida-log-callback" class="headerlink" title="frida_log_callback"></a>frida_log_callback</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> frida_log_callback = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">sp:NativePointer</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> s = sp.<span class="title function_">readUtf8String</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>This function has one argument of type NativePointer. C code passes a pointer to a string to this function.<br>Line 2 read a string from given address.<br>Line 3 outputs the string to Frida.</p>
<h3 id="frida-log-cstring-callback"><a href="#frida-log-cstring-callback" class="headerlink" title="frida_log_cstring_callback"></a>frida_log_cstring_callback</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> frida_log_cstring_callback = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">pString:NativePointer</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> s = pString.<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readPointer</span>().<span class="title function_">readUtf8String</span>(); <span class="comment">// get string to a pointer to a std::string object</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;,<span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>Cocos2D stores the version string in a std::string. So we needs a function to extract the actual string from the std::string object and print it.<br>This function has only one argument, it also is of type NativePoiner, but it should be a pointer to a std::string object<br>Line 2 extracts the actual string from the given std::string object. Note: Android developers can specify different variable in their <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/application_mk">Application.mk</a> file. Variables APP_ABI, APP_STL may determine different implementations of std::string class. So current method to extract a string may not work correctly when you hack other Android APKs.<br>Line 3 outputs extracted string to Frida.</p>
<h2 id="Our-own-CModule"><a href="#Our-own-CModule" class="headerlink" title="Our own CModule"></a>Our own CModule</h2><p>I wrote a CModule to show the Cocos2D application version string by using the functions has exist in libMyGame.so. I put code it file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/cmoduletest.ts">cmoduletest.ts</a>.</p>
<h3 id="Cocos2d-functions-for-get-version-string"><a href="#Cocos2d-functions-for-get-version-string" class="headerlink" title="Cocos2d functions for get version string"></a>Cocos2d functions for get version string</h3><p>I read the <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.0rc2/db/de2/classcocos2d_1_1_application.html">official documentation</a> in Cocos2d website. Class cocos2d::Application has 2 function we can use:</p>
<ul>
<li>static Application* getInstance 	()<br>  <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.0rc2/db/de2/classcocos2d_1_1_application.html#aa98b8f5621b53c808429f5dde0662921">doc</a><br>  This function return a pointer to the current application instance.</li>
<li>const std::string&amp; getVersion () const<br>  <a target="_blank" rel="noopener" href="https://cocos2d-x.org/reference/native-cpp/V3.3rc0/dc/db1/classcocos2d_1_1extension_1_1_manifest.html#aad022179566240a5612dfa964152d704">doc</a><br>  This function return a std::string reference to the version string. A C++ reference is a pointer in machine code actually.</li>
</ul>
<h3 id="Call-Cocos2d-functions"><a href="#Call-Cocos2d-functions" class="headerlink" title="Call Cocos2d functions"></a>Call Cocos2d functions</h3><p>The following is the code </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test0 = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> soname =<span class="string">&quot;libMyGame.so&quot;</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(soname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> loadm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        void* _ZN7cocos2d11Application11getInstanceEv ();</span></span><br><span class="line"><span class="string">        const char* _ZN7cocos2d11Application10getVersionEv(void*);</span></span><br><span class="line"><span class="string">        extern void frida_log_callback(const char* s);</span></span><br><span class="line"><span class="string">        extern void frida_log_cstring_callback(void*);</span></span><br><span class="line"><span class="string">        void fun(void) &#123;</span></span><br><span class="line"><span class="string">            frida_log_callback(&quot;Hello World from CModule&quot;);</span></span><br><span class="line"><span class="string">            void* pApplication = _ZN7cocos2d11Application11getInstanceEv();</span></span><br><span class="line"><span class="string">            const char* version = _ZN7cocos2d11Application10getVersionEv(pApplication);</span></span><br><span class="line"><span class="string">            frida_log_callback(&quot;cocos2d application version: &quot;);</span></span><br><span class="line"><span class="string">            frida_log_cstring_callback((void*)version);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      frida_log_callback  : fridautils.<span class="property">frida_log_callback</span>,</span><br><span class="line">      frida_log_cstring_callback  : fridautils.<span class="property">frida_log_cstring_callback</span>,</span><br><span class="line">      <span class="comment">// cocos2d::Application::getInstance</span></span><br><span class="line">      <span class="comment">// use this static function  to get a pointer to the current Application instance</span></span><br><span class="line">      _ZN7cocos2d11Application11getInstanceEv : m.<span class="title function_">getExportByName</span>(<span class="string">&quot;_ZN7cocos2d11Application11getInstanceEv&quot;</span>), </span><br><span class="line">      <span class="comment">// const char* cocos2d::Application::getVersion(void*)</span></span><br><span class="line">      <span class="comment">// use this member function of class Application to get a version string </span></span><br><span class="line">      <span class="attr">_ZN7cocos2d11Application10getVersionEv</span>: m.<span class="title function_">getExportByName</span>(<span class="string">&quot;_ZN7cocos2d11Application10getVersionEv&quot;</span>), </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(loadm));</span><br><span class="line">    fridautils.<span class="title function_">runFunWithExceptHandling</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> fun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(loadm.<span class="property">fun</span>, <span class="string">&#x27;void&#x27;</span>,[])</span><br><span class="line">        <span class="title function_">fun</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Line 6-16 is the C code.<br>Line 6-7 declares the Cocos2d functions we will using. Because we are in C, so we only can use mangled function names.<br>Line 8-9 declares the helper functions we created in Typescript.<br>Line 10-16, we create a function named <code>fun</code> to do our actual work<br>Line 12, we get the current application instance address using function cocos2d::Application::getInstance, this function is a static function, and it has no argument, we store the result to variable <code>pApplication</code>;<br>Line 13, we get a pointer to a std::string object  using function cocos2d::Application::getVersion, this function is a member function, and it needs a <code>this</code> pointer as its first argument. We just pass variable <code>pApplication</code> to it.<br>Line 14-15. We print version string using helper functions.<br>LIne 19-26. We needs to pass all functions to the CModule using a dictionary. In the dictionary,  key is the function name, and value is the function address.  We call Module.getExportByName to get the functions address in the libMyGame.so</p>
<h2 id="Compile-amp-run"><a href="#Compile-amp-run" class="headerlink" title="Compile &amp; run"></a>Compile &amp; run</h2><p>I wrote a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts/blob/master/Makefile">makefile</a> for compilation.<br>We can use the following cmd to compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make build_cmoduletest</span><br></pre></td></tr></table></figure>
<p>And use the following cmd to run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see the output as follows</p>
<blockquote>
<p>Hello World from CModule<br>cocos2d application version:<br>1.8.12<br>This game’s Cocos2d application version is <code>1.8.12</code></p>
</blockquote>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Now, we know how to call the existing functions using CModule. Cocos2D exports a lot of functions in its native library file. We can do many things using these functions.<br>All code is in my <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/fridahackingtuts">github</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-25T07:23:24.000Z" title="6/25/2022, 3:23:24 PM">2022-06-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">5 minutes read (About 734 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/25/Frida-android-basic/">Frida Android basics</a></p><div class="content"><p>This article introduces the basics about how to use Frida on Android platform.</p>
<h1 id="About-Frida"><a href="#About-Frida" class="headerlink" title="About Frida"></a>About Frida</h1><p><a target="_blank" rel="noopener" href="https://frida.re/">Frida</a> is a great tool working on Windows, macOS and GNU&#x2F;Linux allowing you to inject snippets of code into native apps. In this tutorial we’ll use Frida to inject code into Android applications.</p>
<p>Frida has 2 work modes, one is client-server, the other is gadget mode.</p>
<h2 id="Server-mode"><a href="#Server-mode" class="headerlink" title="Server mode"></a>Server mode</h2><p>The server runs on the Android phone and the client on your computer. Note that you need a phone or an Android emulator that rooted.</p>
<h4 id="Frida-installation"><a href="#Frida-installation" class="headerlink" title="Frida installation"></a>Frida installation</h4><p>Installing Frida on your computer is a super easy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install frida-tools</span><br></pre></td></tr></table></figure>
<p>Note that the latest Python 3 is recommended. Lets check which version is installed:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frida --version</span><br></pre></td></tr></table></figure>
<p>And we need to find the architecture of you phone.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell getprop ro.product.cpu.abi</span><br></pre></td></tr></table></figure>
<p>Now, we need to install the server on our Android phone. Visit <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida release</a> page, and find a file named like “frida-server-XX.XX.XX-android-YYYY.xz”. ‘XX.XX.XX’ is the version of your installed frida, and YYYY is the architecture of your Android device. Note frida server version should be better to match the frida version on you computer.<br>We uncompress the archive and rename the server to “frida-server”<br>And install the server on the phone:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ adb root <span class="comment"># might be required</span></span><br><span class="line">$ adb push frida-server /data/local/tmp/</span><br><span class="line">$ adb shell <span class="string">&quot;chmod 777 /data/local/tmp/frida-server&quot;</span></span><br></pre></td></tr></table></figure>
<p>Now try to start the server.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell <span class="string">&quot;/data/local/tmp/frida-server &amp;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="Frida-test"><a href="#Frida-test" class="headerlink" title="Frida test"></a>Frida test</h3><p>Run the following command to list all applications on your Android device:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -Uai</span><br></pre></td></tr></table></figure>
<h2 id="Gadget-mode"><a href="#Gadget-mode" class="headerlink" title="Gadget mode"></a>Gadget mode</h2><p>This mode needs not a rooted android device, but need to repackage APKs you wnat to hack.</p>
<h3 id="Download-Gadget-file"><a href="#Download-Gadget-file" class="headerlink" title="Download Gadget file"></a>Download Gadget file</h3><p>Also visit <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida release</a> page, and find a file named like “frida-gadget-XX.XX.XX-android-YYYY.so.xz”. ‘XX.XX.XX’ is the version of your installed frida, and YYYY is the architecture of your Android device.<br>We uncompress the archive and rename the so to “libgadget.so”</p>
<h3 id="Inject-libgadget-so-to-your-APK"><a href="#Inject-libgadget-so-to-your-APK" class="headerlink" title="Inject libgadget.so to your APK"></a>Inject libgadget.so to your APK</h3><p>Try to find any native library file in you APK, and inject libgadget.so to it.<br>The following is a Python script to inject libgadget.so, just add libgadget.so as a dependency of a native libraries embedded in the APK.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief <span class="comment"># you can install lief package with `pip install lief`</span></span><br><span class="line">libnative = lief.parse(<span class="string">&quot;libnative.so&quot;</span>) <span class="comment"># you should replace libnative.so to you actual so file name</span></span><br><span class="line">libnative.add_library(<span class="string">&quot;libgadget.so&quot;</span>) <span class="comment"># Injection!</span></span><br><span class="line">libnative.write(<span class="string">&quot;libnative.so&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Write-a-gadget-config-file"><a href="#Write-a-gadget-config-file" class="headerlink" title="Write a gadget config file"></a>Write a gadget config file</h3><p>Create a file name with ‘libgadget.config.so’. and put the following content in it:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;interaction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;listen&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;on_load&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wait&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>And copy this file into same directory with your patched libnative.so in. </p>
<h3 id="Repackage-APK-file"><a href="#Repackage-APK-file" class="headerlink" title="Repackage APK file"></a>Repackage APK file</h3><p>There are many APK repackage utils. I prefer <a target="_blank" rel="noopener" href="https://forum.xda-developers.com/t/discontinued-windows-apk-easy-tool-v1-60-2022-06-23.3333960/">APK easy Tool</a></p>
<h3 id="Frida-test-1"><a href="#Frida-test-1" class="headerlink" title="Frida test"></a>Frida test</h3><p>If you install patched APK to your Android device and open it.<br>The app seems it sucks, don’t be worry, it’s waiting for you to run frida client to connect it.<br>Run the following command, you will find a process with a name ‘Gadget’.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -Uai</span><br></pre></td></tr></table></figure>
<p>This process just is your patched APK, and we can not see other applications, because we’re not root now</p>
<h2 id="Getting-started-with-Frida"><a href="#Getting-started-with-Frida" class="headerlink" title="Getting started with Frida"></a>Getting started with Frida</h2><h3 id="Write-a-javascript-file-you-want-to-inject"><a href="#Write-a-javascript-file-you-want-to-inject" class="headerlink" title="Write a javascript file you want to inject"></a>Write a javascript file you want to inject</h3><p>The content of the test javascript file (named tt.js)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Inject-javascript-code-to-an-Android-process"><a href="#Inject-javascript-code-to-an-Android-process" class="headerlink" title="Inject javascript code to an Android process"></a>Inject javascript code to an Android process</h3><p>Frida provides serval utils to let us life easy. One of them is ‘frida’.<br>Run the following command to connect to your wait process in gadget mode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -n Gadget -l tt.js --no-pause </span><br></pre></td></tr></table></figure>
<p>You will see a frida shell, and it print ‘hello world’<br>For client&#x2F;server mode, you should run frida with other options:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f &lt;package name&gt; -l tt.js --no-pause  # this command will reopen your app</span><br></pre></td></tr></table></figure>
<p>or </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -n &lt;app title&gt; -l tt.js --no-pause  # this command do not reopen your app</span><br></pre></td></tr></table></figure>


<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Now we can inject a basic javascript code into an Android app, you can refer <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">frida Javascript documentation</a> for more learning.</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Meng Xipeng"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Meng Xipeng</p><p class="is-size-6 is-block">Reverse engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/mengxipeng1122" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/meng_xi_peng"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-22T07:22:24.000Z">2024-01-22</time></p><p class="title"><a href="/2024/01/22/Mastering-Frida-A-Guide-to-Fixing-Early-Instrumentation-in-Gadget-Mode/">Mastering Frida: A Guide to Fixing Early Instrumentation in Gadget Mode</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-07T08:42:04.000Z">2024-01-07</time></p><p class="title"><a href="/2024/01/07/How-to-indentify-NDK-version-of-a-so/">Identifying the NDK Version of a .so File</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-28T00:41:13.000Z">2023-10-28</time></p><p class="title"><a href="/2023/10/28/Hacking-Cocos2D-Android-Games-using-Frida/">Hacking Cocos2D Android Games using Frida</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-31T07:24:00.000Z">2023-08-31</time></p><p class="title"><a href="/2023/08/31/Hacking-Android-game-using-Frida-Part3/">Hacking Android Game using Frida - Part3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-29T06:53:23.000Z">2023-08-29</time></p><p class="title"><a href="/2023/08/29/Hacking-Android-game-using-Frida-Part2/">Hacking Android game using Frida - Part2</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ARM/"><span class="tag">ARM</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CModule/"><span class="tag">CModule</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos2d/"><span class="tag">Cocos2d</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Frida/"><span class="tag">Frida</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Game/"><span class="tag">Game</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hack/"><span class="tag">Hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hacking/"><span class="tag">Hacking</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Inline-hook/"><span class="tag">Inline hook</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse/"><span class="tag">Reverse</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-engineering/"><span class="tag">Reverse engineering</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thumb/"><span class="tag">Thumb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hack/"><span class="tag">hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hacking/"><span class="tag">hacking</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inlinehook/"><span class="tag">inlinehook</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Meng Xipeng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>