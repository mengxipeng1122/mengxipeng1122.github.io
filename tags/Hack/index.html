<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: Hack - Meng Xipeng&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Meng Xipeng&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Meng Xipeng&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Meng Xipeng&#039;s blog"><meta property="og:url" content="http://mengxipeng1122.github.io/"><meta property="og:site_name" content="Meng Xipeng&#039;s blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://mengxipeng1122.github.io/img/og_image.png"><meta property="article:author" content="Meng Xipeng"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://mengxipeng1122.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://mengxipeng1122.github.io"},"headline":"Meng Xipeng's blog","image":["http://mengxipeng1122.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Meng Xipeng"},"publisher":{"@type":"Organization","name":"Meng Xipeng's blog","logo":{"@type":"ImageObject","url":"http://mengxipeng1122.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">Hack</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-08-07T06:12:53.000Z" title="8/7/2023, 2:12:53 PM">2023-08-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">7 minutes read (About 1113 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/08/07/Hacking-pandroa-s-box-game-cartridge-2/">Hacking Pandora&#039;s Box Game Cartridge 2</a></p><div class="content"><h1 id="Disclaimer"><a href="#Disclaimer" class="headerlink" title="Disclaimer"></a>Disclaimer</h1><p>This blog is intended solely for educational purposes. Please refrain from using this information for malicious purposes.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I recently acquired a new Pandora’s Box game cartridge, which utilizes the RK3128 system-on-a-chip (SOC) from Rockchip. I wanted to share my experience with hacking it.<br>The manufacturer has overclocked it to 1.5GHz to ensure smooth gameplay with HD video filtering. However, due to the increased performance, an additional fan is required for cooling. Fortunately, the cartridge uses an SD card for booting, making it easy to dump the firmware.Here is a photo of the PCB:<br><img src="/images/PB2_PCB.jpg" alt="PCB"></p>
<h1 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h1><p>The system initiates the “loader” program to extract necessary files and launch the main program, “mkemu.” The manufacturer has placed the “loader” in the initram filesystem of the kernel, which is in CPIO format. Extracting the “loader” binary is a straightforward process.<br>The following code snippet from &#x2F;etc&#x2F;init.d&#x2F;rcS in the initram reveals how the system starts the “loader” program:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">PATH=/bin:/sbin:/usr/bin:/usr/sbin</span><br><span class="line">runlevel=S</span><br><span class="line">prevlevel=N</span><br><span class="line"><span class="built_in">umask</span> 022</span><br><span class="line"><span class="built_in">export</span> PATH runlevel prevlevel</span><br><span class="line"></span><br><span class="line">mount -t tmpfs mdev /dev</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line"><span class="built_in">mkdir</span> /dev/shm</span><br><span class="line"></span><br><span class="line">mount -a</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">mdev -s</span><br><span class="line"></span><br><span class="line"><span class="built_in">touch</span> /dev/mdev.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"><span class="built_in">mkdir</span> -m 1777 .X11-unix</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /lib/modules/3.4.39-h3</span><br><span class="line">insmod elib.ko</span><br><span class="line"><span class="comment">#insmod ch341.ko</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        /home/games/loader</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="Analyzing-the-Loader-Program"><a href="#Analyzing-the-Loader-Program" class="headerlink" title="Analyzing the Loader Program"></a>Analyzing the Loader Program</h2><p>I loaded the “loader” program into Ghidra and performed an automated analysis. At address 0x11b10, it becomes evident that the “loader” attempts to mount a LUKS filesystem file:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(uStack_620,<span class="string">&quot;echo -n \&quot;%s\&quot; | cryptsetup luksOpen /dev/dm-1 pass -&quot;</span>,&amp;DAT_00028c94);</span><br><span class="line">system(uStack_620);</span><br></pre></td></tr></table></figure>
<p>The LUKS key is stored in ASCII format at address DAT_00028c94 and is calculated using a number read from &#x2F;dev&#x2F;elib. The function at 0x14720 includes the code to read the original number from &#x2F;dev&#x2F;elib:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">read_rand_seed</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> __fd;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  </span><br><span class="line">  __fd = open(<span class="string">&quot;/dev/elib&quot;</span>,<span class="number">0</span>);</span><br><span class="line">  elib_fd = __fd;</span><br><span class="line">  <span class="keyword">if</span> (__fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    iVar1 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar1 = ioctl(__fd,<span class="number">0x80045a13</span>,data);</span><br><span class="line">    iVar1 = iVar1 &gt;&gt; <span class="number">0x1f</span>;</span><br><span class="line">    close(__fd);</span><br><span class="line">    elib_fd = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> iVar1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fortunately, the programmer compiled the Linux driver into an individual .ko file instead of including it in the kernel binary. This allows us to easily locate the code responsible for returning the number within the small .ko file.</p>
<h2 id="Analyzing-elib-ko"><a href="#Analyzing-elib-ko" class="headerlink" title="Analyzing elib.ko"></a>Analyzing <code>elib.ko</code></h2><p>We can find elib.ko in the CPIO filesystem. By loading it into Ghidra, we can locate the code that handles the 0x80045a13 ioctl code in the elib_ioctl function. Ghidra’s decompiled C code provides the following information:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (param_2 == <span class="number">0x80045a13</span>) &#123;</span><br><span class="line">  local_2c = (undefined *)<span class="number">0x0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;local_28,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">  pcVar2 = <span class="built_in">strstr</span>(saved_command_line,<span class="string">&quot;custom_id=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (pcVar2 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    pcVar2 = pcVar2 + <span class="number">10</span>;</span><br><span class="line">    pcVar3 = <span class="built_in">strchr</span>(pcVar2,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar3 == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      __n = <span class="built_in">strlen</span>(pcVar2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      __n = (<span class="type">int</span>)pcVar3 - (<span class="type">int</span>)pcVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__n &lt; <span class="number">0x10</span>) &#123;</span><br><span class="line">      <span class="built_in">strncpy</span>((<span class="type">char</span> *)&amp;local_28,pcVar2,__n);</span><br><span class="line">      local_2c = (undefined *)simple_strtoul(&amp;local_28,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (local_2c == (undefined *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    local_2c = (undefined *)<span class="number">0x87654321</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  printk(<span class="string">&quot;\x011custom id: %x\n&quot;</span>,(uint)local_2c);</span><br><span class="line">  puVar6 = *(undefined **)(((uint)local_38 &amp; <span class="number">0xffffe000</span>) + <span class="number">8</span>);</span><br><span class="line">  bVar12 = (undefined *)<span class="number">0xfffffffb</span> &lt; param_3;</span><br><span class="line">  <span class="keyword">if</span> (!bVar12) &#123;</span><br><span class="line">    bVar12 = puVar6 &lt; param_3 + <span class="number">4</span> || (uint)((<span class="type">int</span>)(param_3 + <span class="number">4</span>) - (<span class="type">int</span>)puVar6) &lt; (uint)bVar12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!bVar12) &#123;</span><br><span class="line">    puVar6 = (undefined *)<span class="number">0x0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (puVar6 != (undefined *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ppuVar4 = &amp;local_2c;</span><br><span class="line">  uVar5 = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">goto</span> LAB_00010668;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (param_2 != <span class="number">0x80045a0b</span>) <span class="keyword">goto</span> LAB_00010674;</span><br></pre></td></tr></table></figure>
<p>And the programmer is lazy, as he hardcoded this sensitive number. It’s 0x87654321. I noticed there is an MCU on the PCB, and I suspected the programmer might have stored the number in the MCU, but he didn’t.</p>
<h2 id="Find-the-key-for-the-LUKS-file"><a href="#Find-the-key-for-the-LUKS-file" class="headerlink" title="Find the key for the LUKS file"></a>Find the key for the LUKS file</h2><p>Now, it’s time to calculate the key for the LUKS file. I decided to use <a target="_blank" rel="noopener" href="https://www.unicorn-engine.org/">unicorn engine</a> for this task, I wrote a python <a target="_blank" rel="noopener" href="https://gist.github.com/mengxipeng1122/dc6b97944f370bf0f87a377946971229">script</a> for this task.<br>This script requires the preparation of the file rocky.rsa and the number 0x87654321. The thumb instructions call the standard libc functions, memset and memcpy. I simulate these two functions in the block_hook section. The following is the code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(address==<span class="number">0x10cb4</span>):  </span><br><span class="line">    <span class="comment"># void * memset(void *__s,int __c,size_t __n)</span></span><br><span class="line">    s = uc.reg_read(UC_ARM_REG_R0)</span><br><span class="line">    c = uc.reg_read(UC_ARM_REG_R1)</span><br><span class="line">    n = uc.reg_read(UC_ARM_REG_R2)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;hook memset&#x27;</span>, <span class="built_in">hex</span>(s), c, n)</span><br><span class="line">    uc.mem_write(s, <span class="built_in">bytes</span>([c]*n))</span><br><span class="line">    uc.reg_write(UC_ARM_REG_R0, s)</span><br><span class="line">    uc.reg_write(UC_ARM_REG_PC, uc.reg_read(UC_ARM_REG_LR))</span><br><span class="line"><span class="keyword">elif</span>(address==<span class="number">0x10d2c</span>):  </span><br><span class="line">    <span class="comment"># void * memcpy(void *__dest,void *__src,size_t __n)</span></span><br><span class="line">    __dest = uc.reg_read(UC_ARM_REG_R0)</span><br><span class="line">    __src  = uc.reg_read(UC_ARM_REG_R1)</span><br><span class="line">    __n    = uc.reg_read(UC_ARM_REG_R2) <span class="comment">#<span class="doctag">TODO:</span> hack</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;hook memcpy&#x27;</span>, <span class="built_in">hex</span>(__dest), <span class="built_in">hex</span>(__src), __n)</span><br><span class="line">    dat = uc.mem_read(__src,__n)</span><br><span class="line">    uc.mem_write(__dest,<span class="built_in">bytes</span>(dat));</span><br><span class="line">    uc.reg_write(UC_ARM_REG_R0, __dest)</span><br><span class="line">    uc.reg_write(UC_ARM_REG_PC, uc.reg_read(UC_ARM_REG_LR))</span><br></pre></td></tr></table></figure>
<p>If the script succeeds, we can get the LUKS key at address 0x28c94. It is a string, and we can use this key to mount the LUKS file on a PC.</p>
<h2 id="Decrypt-config-dat-file"><a href="#Decrypt-config-dat-file" class="headerlink" title="Decrypt config.dat file"></a>Decrypt config.dat file</h2><p>The function at 0x011dc8 is a decryption function. loader uses it to decrypt config.dat and other configuration files for gaming. I wrote a Python <a target="_blank" rel="noopener" href="https://gist.github.com/mengxipeng1122/b161b62ce6ecaa9479ada6b1b45f99d8">script</a> to perform this decryption. The script saves the resulting file to &#x2F;tmp&#x2F;tt.bin.</p>
<h1 id="mkemu"><a href="#mkemu" class="headerlink" title="mkemu"></a>mkemu</h1><p><code>loader</code> starts <code>mkemu</code> using system. We can find the related instruction at address 0x01153c in <code>loader</code>. The Ghidra decompiled C code is as follows:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;/home/games/mkemu&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;User app exit.&quot;</span>);</span><br><span class="line">  usleep(<span class="number">10000</span>);</span><br><span class="line">&#125; <span class="keyword">while</span>( <span class="literal">true</span> );</span><br></pre></td></tr></table></figure>
<h2 id="Analyzing-the-mkemu-program"><a href="#Analyzing-the-mkemu-program" class="headerlink" title="Analyzing the mkemu program"></a>Analyzing the mkemu program</h2><p>mkemu is the essential program for this game cartridge. It displays the game selection menu and allows users to play their selected game. After analyzing it using Ghidra, I believe it utilizes SDL.</p>
<h2 id="Decrypt-asset"><a href="#Decrypt-asset" class="headerlink" title="Decrypt asset"></a>Decrypt asset</h2><p>The programmer encrypted and packaged the assets in the file asset.dat. Therefore, we need to decrypt the assets using the Thumb instructions in mkemu. You can find the complete Python script in <a target="_blank" rel="noopener" href="https://gist.github.com/mengxipeng1122/22aee547f2f8348cfe469ca771671f5a">here</a>. This script will save each decrypted asset file in the target folder.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>This board isn’t very difficult, and I feel like hacking it is similar to participating in a Capture The Flag (CTF) competition. Every key is like a flag. The only difference is that the board is real.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-01-04T01:10:13.000Z" title="1/4/2023, 9:10:13 AM">2023-01-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-10-05T06:19:13.301Z" title="10/5/2023, 2:19:13 PM">2023-10-05</time></span><span class="level-item">15 minutes read (About 2260 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/01/04/hacking-pandroa-s-box-game-cartridge-1/">Hacking pandroa&#039;s box game cartridge 1</a></p><div class="content"><h1 id="Disclaimer"><a href="#Disclaimer" class="headerlink" title="Disclaimer"></a>Disclaimer</h1><p>This blog is only for educational purposes. Never use these info for bad.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><a target="_blank" rel="noopener" href="https://www.facebook.com/pb3aracde/">Pandora’s box multi-game cartridge</a> is a popular product from China. This cartridge usually has 1000+ retro arcade games. It supports Jamma and HDMI. Users can enjoy old-time games with it. And some newer versions of it have more than 10,000 games, and support some home console games. Many manufactures from China have the ability to design and product Pandora’s box multi-game cartridge. They always add software protection to prevent others from cloning their efforts.<br>Recently, I got a newer version of PB boards. And I hacked it. I will introduce the steps of how I hacked this board.<br>The PCB is as follows:<br><img src="/images/PB1_PCB.jpg" alt="PCB"><br>I uploaded all code to <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/hackingPB1">github</a></p>
<h1 id="Tools-x2F-Packages-I-used"><a href="#Tools-x2F-Packages-I-used" class="headerlink" title="Tools&#x2F;Packages I used"></a>Tools&#x2F;Packages I used</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/redox-os/binutils-gdb/blob/master/binutils/strings.c">strings</a> is a GNU util to output all printable strings in files.</li>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/binutils/strings.html">file</a> is a GNU util to determine files type.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ReFirmLabs/binwalk">binwalk</a> is a easy way to extract firmware from an image file.</li>
<li><a target="_blank" rel="noopener" href="https://ghidra-sre.org/">Ghidra</a> is a great suite for disassembling and decompiling binary from variety platforms.</li>
<li><a target="_blank" rel="noopener" href="https://www.unicorn-engine.org/">Unicorn</a> is a lightweight multi-platform, multi-architecture CPU emulator framework.</li>
</ul>
<h1 id="Inspect-image"><a href="#Inspect-image" class="headerlink" title="Inspect image"></a>Inspect image</h1><p>This board uses <a target="_blank" rel="noopener" href="https://dn.odroid.com/S805/Datasheet/S805_Datasheet%20V0.8%2020150126.pdf">Amlogic s805</a>. This SOC is old, and not very powerful for running some 3D games. I think the manufaturer selected this SOC only beacause it’s cheap. This SOC only cost near to $1 if they select to use second-hard ICs.<br>This board has s805, a memory IC, and no EMMC IC. It has a TF card of size 32GB, this board uses TF card boot mode.<br>The TF card has 2 partitions, shown as the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ fdisk -l pb1.img</span><br><span class="line">Disk pb1.img: 29.57 GiB, 31739999744 bytes, 61992187 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x00007577</span><br><span class="line"></span><br><span class="line">Device     Boot   Start      End  Sectors  Size Id Type</span><br><span class="line">pb1.img1           8192  1441791  1433600  700M  6 FAT16</span><br><span class="line">pb1.img2        1441792 60440575 58998784 28.1G  c W95 FAT32 (LBA)</span><br></pre></td></tr></table></figure>
<p>I mounted partition 1 to check its files:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount -oloop,ro,offset=$((<span class="number">8192</span>*<span class="number">512</span>)) pb1.img /mnt/disk</span><br><span class="line">$ <span class="built_in">ls</span> /mnt/disk -l</span><br><span class="line">total 684384</span><br><span class="line">-rwxr-xr-x 1 root root   1843272 9月  26  2021  logicalcircuit</span><br><span class="line">-rwxr-xr-x 1 root root     60268 9月  26  2021  logo_en.png</span><br><span class="line">-rwxr-xr-x 1 root root     60268 9月  26  2021  logo_ko.png</span><br><span class="line">-rwxr-xr-x 1 root root     60268 9月  26  2021  logo.png</span><br><span class="line">-rwxr-xr-x 1 root root   6678528 9月  26  2021  rxnv</span><br><span class="line">-rwxr-xr-x 1 root root 314572800 1月   3 18:26  rxte</span><br><span class="line">drwxr-xr-x 2 root root     16384 4月  18  2022 <span class="string">&#x27;System Volume Information&#x27;</span></span><br><span class="line">-rwxr-xr-x 1 root root 377487360 1月   3 18:26  user</span><br></pre></td></tr></table></figure>
<p>And checked the file type using <code>file</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ file /mnt/disk/*</span><br><span class="line">/mnt/disk/logicalcircuit:            PC bitmap, Adobe Photoshop with alpha channel mask, 1280 x 720 x 16</span><br><span class="line">/mnt/disk/logo_en.png:               PNG image data, 500 x 120, 8-bit/color RGBA, non-interlaced</span><br><span class="line">/mnt/disk/logo_ko.png:               PNG image data, 500 x 120, 8-bit/color RGBA, non-interlaced</span><br><span class="line">/mnt/disk/logo.png:                  PNG image data, 500 x 120, 8-bit/color RGBA, non-interlaced</span><br><span class="line">/mnt/disk/rxnv:                      data</span><br><span class="line">/mnt/disk/rxte:                      LUKS encrypted file, ver 1 [aes, xts-plain64, sha256] UUID: 3929e3d8-a638-4b24-93d7-a459b77ac901</span><br><span class="line">/mnt/disk/System Volume Information: directory</span><br><span class="line">/mnt/disk/user:                      LUKS encrypted file, ver 1 [aes, xts-plain64, sha256] UUID: 85dbb20b-1880-422f-b4e7-6564b1d13abb</span><br></pre></td></tr></table></figure>
<p>It shows file <code>rxnv</code> maybe encrypted.<br>I uploaded the TF card image file <a target="_blank" rel="noopener" href="https://mega.nz/file/GjhBgBxJ#Di8T4BIvDH1jUG0m71wxWJW3g_9BhEDCi-leX4BZHnE">here</a>. And I striped partition 2 to save room.</p>
<h1 id="Analyse-U-boot"><a href="#Analyse-U-boot" class="headerlink" title="Analyse U-boot"></a>Analyse U-boot</h1><p>U-boot has many versions. We should find U-boot in s805 SDK. I find <a target="_blank" rel="noopener" href="https://wiki.odroid.com/odroid-c1/odroid-c1">Odroid C1</a> is using s805. And I can find partitions table <a target="_blank" rel="noopener" href="https://wiki.odroid.com/odroid-c1/software/partition_table#tab__odroid-c11">here</a>.</p>
<h2 id="Download-related-U-boot-source-code"><a href="#Download-related-U-boot-source-code" class="headerlink" title="Download related U-boot source code"></a>Download related U-boot source code</h2><p>As <a target="_blank" rel="noopener" href="https://wiki.odroid.com/odroid-c1/software/building_u-boot">this page</a> shows, we can download U-boot source from github</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/hardkernel/u-boot.git -b odroidc-v2011.03</span><br></pre></td></tr></table></figure>
<h2 id="Extract-U-boot-binary"><a href="#Extract-U-boot-binary" class="headerlink" title="Extract U-boot binary"></a>Extract U-boot binary</h2><p>We can extract U-boot from the image accord to partitions table </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=pb1.img skip=64 count=$((<span class="number">8192</span>-<span class="number">64</span>)) of=uboot.bin</span><br><span class="line"><span class="comment"># 8192 is the start block of the paration 1</span></span><br><span class="line">$ file uboot.bin </span><br><span class="line">uboot.bin: UCL compressed data</span><br></pre></td></tr></table></figure>
<p>If we compile U-boot successfully, we can get a tool <code>build/tools/uclpack</code> to decompress UCL data. I guess UCL is the special package format for s805.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ build/tools/uclpack -d  uboot.bin uboot.bin.decompressed</span><br><span class="line"></span><br><span class="line">UCL data compression library (v1.03, Jul 20 2004).</span><br><span class="line">Copyright (C) 1996-2004 Markus Franz Xaver Johannes Oberhumer</span><br><span class="line">http://www.oberhumer.com/opensource/ucl/</span><br><span class="line"></span><br><span class="line">uclpack: block-size is 262144 bytes</span><br><span class="line">uclpack: decompressed 340268 into 740288 bytes</span><br><span class="line"></span><br><span class="line">$ file uboot.bin.decompressed </span><br><span class="line">uboot.bin.decompressed: data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>file</code> can not recognize U-boot type. But <code>strings</code> can still give us some useful info.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ strings -tx uboot.bin.decompressed </span><br><span class="line">&lt;...&gt;</span><br><span class="line">  a9b72 switch_bootmode=<span class="keyword">if</span> <span class="built_in">test</span> <span class="variable">$&#123;reboot_mode&#125;</span> = factory_reset; <span class="keyword">then</span> run recovery;<span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">test</span> <span class="variable">$&#123;reboot_mode&#125;</span> = update; <span class="keyword">then</span> run update; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">test</span> <span class="variable">$&#123;reboot_mode&#125;</span> = usb_burning; <span class="keyword">then</span> run usb_burning;<span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">test</span> <span class="variable">$&#123;wipe_data&#125;</span> = failed; <span class="keyword">then</span> <span class="built_in">echo</span> wipe_data=<span class="variable">$&#123;wipe_data&#125;</span>; run recovery;<span class="keyword">else</span>   <span class="keyword">fi</span>;<span class="keyword">fi</span>;<span class="keyword">fi</span>;<span class="keyword">fi</span></span><br><span class="line">  a9c98 prepare=logo size <span class="variable">$&#123;outputmode&#125;</span>; video open; video clear; video dev open <span class="variable">$&#123;outputmode&#125;</span>;<span class="keyword">if</span> fatload mmc 0 0x13000000 logicalcircuit; <span class="keyword">then</span> bmp display 0x13000000; bmp scale;<span class="keyword">fi</span>;</span><br><span class="line">  a9d46 storeboot=<span class="built_in">echo</span> Rx Booting...; <span class="keyword">if</span> unifykey get usid; <span class="keyword">then</span>  setenv bootargs <span class="variable">$&#123;bootargs&#125;</span> androidboot.serialno=<span class="variable">$&#123;usid&#125;</span>;<span class="keyword">fi</span>;<span class="built_in">echo</span> [Maple] <span class="built_in">read</span> info...; <span class="keyword">if</span> mmcinfo; <span class="keyword">then</span> <span class="keyword">if</span> fatload mmc 0 <span class="variable">$&#123;loadaddr&#125;</span> rxnv; <span class="keyword">then</span> setenv bootargs <span class="variable">$&#123;bootargs&#125;</span> bootfromsd; bootm;<span class="keyword">fi</span>;<span class="keyword">fi</span>; <span class="built_in">echo</span> failed...; run recovery</span><br><span class="line">  a9e62 recovery=<span class="built_in">echo</span> enter recovery;<span class="keyword">if</span> mmcinfo; <span class="keyword">then</span> <span class="keyword">if</span> fatload mmc 0 <span class="variable">$&#123;loadaddr&#125;</span> recovery.img; <span class="keyword">then</span> bootm;<span class="keyword">fi</span>;<span class="keyword">fi</span>; <span class="keyword">if</span> usb start 0; <span class="keyword">then</span> <span class="keyword">if</span> fatload usb 0 <span class="variable">$&#123;loadaddr&#125;</span> recovery.img; <span class="keyword">then</span> bootm; <span class="keyword">fi</span>;<span class="keyword">fi</span>;<span class="keyword">if</span> imgread kernel recovery <span class="variable">$&#123;loadaddr&#125;</span>; <span class="keyword">then</span> bootm; <span class="keyword">else</span> <span class="built_in">echo</span> no recovery <span class="keyword">in</span> flash; <span class="keyword">fi</span>;</span><br><span class="line">  a9f77 usb_burning=update 1000</span><br><span class="line">&lt;...&gt;</span><br></pre></td></tr></table></figure>
<p>At 0xa9d46, <code>storeboot</code> environment variable shows U-boot load <code>rxnv</code> file using <code>fatload</code> command, and runs it using <code>bootm</code>. Now I can be sure <code>rxnv</code> actually is the kernel, and it should be encrypted. <code>fatload</code> should have code to decrypt it, or the kernel will not boot.</p>
<h2 id="Locate-decrypt-codes-in-U-boot"><a href="#Locate-decrypt-codes-in-U-boot" class="headerlink" title="Locate decrypt codes in U-boot"></a>Locate decrypt codes in U-boot</h2><p>Now, open <code>uboot.bin.decompressed</code> with Ghidra. I can get U-boot will be loaded at 0x10000000 by check file <code>build/u-boot.map</code> in U-boot source code.<br>That’s the funnest part during the whole hacking. Inspect disassemble code with source code. To make analysis easier, I wrote a header file <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/hackingPB1/blob/master/uboot.h">uboot.h</a>. This file includes some structure definitions. We can import this file into ghidra.After hours of efforts, I found the codes to decrpyt <code>rxnv</code>, it’s at 0x10064aec-0x10064f2c, shown as follows:<br><img src="/images/PB1_screenshot_01.png" alt="Screenshot">.<br>And these codes mainly do the following things:</p>
<ul>
<li>Check the name of the file currently loading, if it is <code>rxnv</code> then decrytpt;</li>
<li>It seems to prepare key in the first loop;</li>
<li>Decrypt data in the sencode loop;<br>And I found ghidra’s register renaming makes it not very easy to know the actual register name in every assembly instruction, just like instruction <code>mov  maxsize, #0x4</code> at 0x10064af0. We can use <code>Patch Instruction</code> menu item in the context menu to check the original instructions.</li>
</ul>
<h2 id="Decrypt-data-using-code-in-U-boot"><a href="#Decrypt-data-using-code-in-U-boot" class="headerlink" title="Decrypt data using code in U-boot"></a>Decrypt data using code in U-boot</h2><p>Let’s decrypt <code>rxnv</code> using the code we found.  I worte a <a target="_blank" rel="noopener" href="https://github.com/mengxipeng1122/hackingPB1/blob/master/decryptrxnv.py">python script</a> for this work. This python script uses unicorn to emulate ARM instructions in U-boot to decrypt <code>rxnv</code> file.</p>
<ul>
<li>Create an ARM emulator<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mu = Uc(UC_ARCH_ARM, UC_MODE_ARM)</span><br></pre></td></tr></table></figure></li>
<li>Allocate memory<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mu.mem_map(code_ptr, <span class="number">0x10000000</span>); <span class="comment"># code_ptr= 0x10000000, I will put U-boot binary in here</span></span><br><span class="line"></span><br><span class="line">mu.mem_map(data_ptr, <span class="number">0x10000000</span>); <span class="comment"># data_ptr= 0x20000000, I will put encrypted data in here;</span></span><br><span class="line"></span><br><span class="line">mu.mem_map(alloc_ptr, <span class="number">0x10000000</span>); <span class="comment"># alloc_ptr= 0x30000000, this rangion if for malloc/free functions</span></span><br><span class="line"></span><br><span class="line">mu.mem_map(<span class="number">0</span>       , <span class="number">0x00200000</span>);  <span class="comment"># this is stack, and set sp_ptr = 0x00100000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>Load data<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  load uboot</span></span><br><span class="line">mu.mem_write(code_ptr, <span class="built_in">open</span>(<span class="string">&#x27;uboot.bin&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line"><span class="comment">#  load data</span></span><br><span class="line">data = <span class="built_in">open</span>(<span class="string">&#x27;rxnv&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read();</span><br><span class="line">datalen = <span class="built_in">len</span>(data);</span><br><span class="line">mu.mem_write(data_ptr, data);</span><br></pre></td></tr></table></figure></li>
<li>Write hook codes<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># callback for tracing basic blocks</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_block</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">    <span class="keyword">if</span> address == <span class="number">0x10016248</span>: <span class="comment"># hook malloc, emulate malloc function, </span></span><br><span class="line">        sz = uc.reg_read(UC_ARM_REG_R0);</span><br><span class="line">        <span class="keyword">global</span> alloc_ptr;</span><br><span class="line">        ret = alloc_ptr;</span><br><span class="line">        alloc_ptr+=sz;</span><br><span class="line">        uc.reg_write(UC_ARM_REG_R0, ret); <span class="comment"># write return value, a pointer to allocated memory</span></span><br><span class="line">        uc.reg_write(UC_ARM_REG_PC, uc.reg_read(UC_ARM_REG_LR));</span><br><span class="line">    <span class="keyword">elif</span> address == <span class="number">0x10015fec</span>: <span class="comment"># hook free, do nothing</span></span><br><span class="line">        uc.reg_write(UC_ARM_REG_PC, uc.reg_read(UC_ARM_REG_LR));</span><br><span class="line">    <span class="keyword">elif</span> address == <span class="number">0x10015bc8</span>: <span class="comment"># hook printf , actual printf function will access to serial port, so I emulate  this function to avoid hardware operations. Unicorn is a great tool to emulate CPU, but is not very easy to implement serial ports.</span></span><br><span class="line">        fmt = uc.reg_read(UC_ARM_REG_R0);</span><br><span class="line">        bs = uc.mem_read(fmt, <span class="number">0x100</span>);</span><br><span class="line">        s = bs.decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&#x27;\0&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">print</span>(s) <span class="comment"># only print the first arguments</span></span><br><span class="line">        uc.reg_write(UC_ARM_REG_PC, uc.reg_read(UC_ARM_REG_LR));</span><br><span class="line">    <span class="keyword">elif</span> address == <span class="number">0x10064d14</span>: <span class="comment"># This is at the begin of the second loop, print loop variable and total loop counter to show decrypt progress</span></span><br><span class="line">        n1=struct.unpack(<span class="string">&#x27;I&#x27;</span>, uc.mem_read(uc.reg_read(UC_ARM_REG_SP)+<span class="number">0x18</span>,<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        n2=struct.unpack(<span class="string">&#x27;I&#x27;</span>, uc.mem_read(uc.reg_read(UC_ARM_REG_SP)+<span class="number">0x28</span>,<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;go here&#x27;</span>, n1, n2);</span><br><span class="line"><span class="comment"># tracing all basic blocks with customized callback</span></span><br><span class="line">mu.hook_add(UC_HOOK_BLOCK, hook_block)</span><br></pre></td></tr></table></figure></li>
<li>Initialize registers and variables in the stack.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mu.reg_write(UC_ARM_REG_R5,     datalen ) <span class="comment"># datalen is length of the encrpyted data</span></span><br><span class="line">mu.reg_write(UC_ARM_REG_R4,     <span class="number">0x100abc80</span>) <span class="comment"># d = 0x100641d4+[0x10064f48]</span></span><br><span class="line">mu.reg_write(UC_ARM_REG_R0,     <span class="number">0</span>       ) <span class="comment">#</span></span><br><span class="line">mu.reg_write(UC_ARM_REG_SP,     sp_ptr  ) <span class="comment"># set stack register</span></span><br><span class="line"><span class="comment"># set maxsize  </span></span><br><span class="line">mu.mem_write(sp_ptr+<span class="number">0x34</span>, struct.pack(<span class="string">&#x27;I&#x27;</span>, <span class="number">0x800000</span>)); <span class="comment"># this variable should be greater than datalen;</span></span><br><span class="line">mu.mem_write(sp_ptr+<span class="number">0x2c</span>, struct.pack(<span class="string">&#x27;I&#x27;</span>, data_ptr)); <span class="comment"># data_ptr is the pointer to encrypted data;</span></span><br></pre></td></tr></table></figure></li>
<li>Emulate <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ADDRESS0 = <span class="number">0x10064b00</span></span><br><span class="line">ADDRESS1 = <span class="number">0x10064f2c</span></span><br><span class="line">mu.emu_start(ADDRESS0, ADDRESS1, count=-<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
<li>Save decrypted data<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;rxnv.decrypted&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>).write(mu.mem_read(data_ptr, datalen)) <span class="comment"># now, data_ptr points to the decrypted data</span></span><br></pre></td></tr></table></figure>
Please note: this script may take a long time to run. I tested it with my PC,(Intel(R) Core(TM) i5-9400 CPU @ 2.90GHz , 6 cores, 16GB DDR), and it took 15 minutes, so I printf loop variable at 0x10064d14.<br>Now, we check decrypted rxnv.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file rxnv.decrypted </span><br><span class="line">rxnv.decrypted: Android bootimg, kernel (0x10008000), ramdisk (0x11000000), second stage (0x10f00000), page size: 2048</span><br></pre></td></tr></table></figure>
It’s a packaged Android kernel.</li>
</ul>
<h1 id="Analyse-Kernel"><a href="#Analyse-Kernel" class="headerlink" title="Analyse Kernel"></a>Analyse Kernel</h1><p>I use <code>binwalk</code> to extract data from <code>rxnv.decrypted</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ binwalk -e rxnv.decrypted </span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Android bootimg, kernel size: 2986048 bytes, kernel addr: 0x10008000, ramdisk size: 3664373 bytes, ramdisk addr: 0x11000000, product name: <span class="string">&quot;&quot;</span></span><br><span class="line">2048          0x800           uImage header, header size: 64 bytes, header CRC: 0x71E73C6F, created: 2022-05-19 17:19:01, image size: 2985984 bytes, Data Address: 0x208000, Entry Point: 0x208000, data CRC: 0x9502FBF, OS: Linux, CPU: ARM, image <span class="built_in">type</span>: OS Kernel Image, compression <span class="built_in">type</span>: gzip, image name: <span class="string">&quot;Linux-3.10.99&quot;</span></span><br><span class="line">2112          0x840           gzip compressed data, has original file name: <span class="string">&quot;ccImage&quot;</span>, from Unix, last modified: 2022-05-19 17:19:00</span><br><span class="line">2990080       0x2DA000        gzip compressed data, from Unix, last modified: 2022-05-19 17:19:01</span><br><span class="line">6656000       0x659000        device tree image (dtb)</span><br></pre></td></tr></table></figure>
<p>The <code>-e</code> flag will extract recognized data to floder <code>_rxnv.decrypted.extracted</code>;<br>Check extracted files:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l _rxnv.decrypted.extracted/</span><br><span class="line">total 13232</span><br><span class="line">-rw-rw-r-- 1 mxp mxp 7429120 1月   4 14:05 2DA000</span><br><span class="line">-rw-rw-r-- 1 mxp mxp 6117776 1月   4 14:05 ccImage</span><br><span class="line">$ file _rxnv.decrypted.extracted/*</span><br><span class="line">_rxnv.decrypted-0.extracted/2DA000:  ASCII cpio archive (SVR4 with no CRC)</span><br><span class="line">_rxnv.decrypted-0.extracted/ccImage: data</span><br></pre></td></tr></table></figure>
<p><code>2DA000</code> is a cpio archive. Use the following commands to depack it;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> cpio.files</span><br><span class="line">$ <span class="built_in">cd</span> cpio.files/</span><br><span class="line">$ sudo cpio -i &lt; ../2DA000 </span><br><span class="line">14510 blocks</span><br></pre></td></tr></table></figure>
<p><code>ccImage</code> should be the kernel binary.</p>
<h2 id="Anslyse-init-script-in-Kernel"><a href="#Anslyse-init-script-in-Kernel" class="headerlink" title="Anslyse init script in Kernel"></a>Anslyse init script in Kernel</h2><p>I checked the <code>init</code> file in the cpio archive. and it’s actually a bash script, and I found commands to mount <code>rxte</code> and <code>user</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">debug_msg <span class="string">&quot;校验运行1&quot;</span></span><br><span class="line">cryptsetup luksOpen /flash/rxte rxsys -d /usr/lib/system.key &amp;</span><br><span class="line">debug_msg <span class="string">&quot;校验运行2&quot;</span></span><br><span class="line">cryptsetup luksOpen /flash/user user -d /usr/lib/system.key &amp;</span><br><span class="line">debug_msg <span class="string">&quot;准备挂载&quot;</span></span><br><span class="line">mount_part <span class="string">&quot;/dev/mapper/rxsys&quot;</span> <span class="string">&quot;/sysroot&quot;</span> <span class="string">&quot;rw,loop&quot;</span></span><br><span class="line">debug_msg <span class="string">&quot;挂载user&quot;</span></span><br><span class="line">mount_part <span class="string">&quot;/dev/mapper/user&quot;</span> <span class="string">&quot;/sysroot/userdata&quot;</span> <span class="string">&quot;rw,loop&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="Recover-true-root-file-system"><a href="#Recover-true-root-file-system" class="headerlink" title="Recover true root file system"></a>Recover true root file system</h2><p>Run the same commands to mount <code>rxte</code> and <code>user</code> file, we can get actual rootfs.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cryptsetup luksOpen rxte rxsys -d _rxnv.decrypted.extracted/cpio.files/usr/lib/system.key</span><br><span class="line">sudo cryptsetup luksOpen user user -d _rxnv.decrypted.extracted/cpio.files/usr/lib/system.key </span><br><span class="line">sudo mount /dev/mapper/rxsys /mnt/disk -o <span class="string">&quot;rw,loop&quot;</span></span><br><span class="line">sudo mount /dev/mapper/user /mnt/disk1 -o <span class="string">&quot;rw,loop&quot;</span></span><br></pre></td></tr></table></figure>
<p>Now we have hacked this board.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Finally, I hacked this board, The primary part is to decrypt <code>rxnv</code> using unicorn. We need not to rewrite instructions in C or Python. All we need to do is emulate the ARM instructions correctly.</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Meng Xipeng"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Meng Xipeng</p><p class="is-size-6 is-block">Reverse engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/mengxipeng1122" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/meng_xi_peng"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-22T07:22:24.000Z">2024-01-22</time></p><p class="title"><a href="/2024/01/22/Mastering-Frida-A-Guide-to-Fixing-Early-Instrumentation-in-Gadget-Mode/">Mastering Frida: A Guide to Fixing Early Instrumentation in Gadget Mode</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-07T08:42:04.000Z">2024-01-07</time></p><p class="title"><a href="/2024/01/07/How-to-indentify-NDK-version-of-a-so/">Identifying the NDK Version of a .so File</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-28T00:41:13.000Z">2023-10-28</time></p><p class="title"><a href="/2023/10/28/Hacking-Cocos2D-Android-Games-using-Frida/">Hacking Cocos2D Android Games using Frida</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-31T07:24:00.000Z">2023-08-31</time></p><p class="title"><a href="/2023/08/31/Hacking-Android-game-using-Frida-Part3/">Hacking Android Game using Frida - Part3</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-29T06:53:23.000Z">2023-08-29</time></p><p class="title"><a href="/2023/08/29/Hacking-Android-game-using-Frida-Part2/">Hacking Android game using Frida - Part2</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ARM/"><span class="tag">ARM</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CModule/"><span class="tag">CModule</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos2d/"><span class="tag">Cocos2d</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Frida/"><span class="tag">Frida</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Game/"><span class="tag">Game</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hack/"><span class="tag">Hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hacking/"><span class="tag">Hacking</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Inline-hook/"><span class="tag">Inline hook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse/"><span class="tag">Reverse</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-engineering/"><span class="tag">Reverse engineering</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thumb/"><span class="tag">Thumb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hack/"><span class="tag">hack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hacking/"><span class="tag">hacking</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inlinehook/"><span class="tag">inlinehook</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Meng Xipeng&#039;s blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Meng Xipeng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mengxipeng1122"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>